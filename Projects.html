<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <title>Rail Work AB – Projekt & Underprojekt</title>
  <style>
    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      background: #f3f4f6;
    }

    /* SIDEBAR */
    .sidebar {
      width: 240px;
      background: #0f172a;
      color: #e5e7eb;
      padding: 16px 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .sidebar h2 {
      font-size: 18px;
      margin: 0 0 16px;
    }

    .nav-section-title {
      font-size: 11px;
      text-transform: uppercase;
      opacity: 0.6;
      margin-top: 12px;
    }

    .nav-item {
      padding: 8px 10px;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
      text-decoration: none;
      color: inherit;
      display: block;
    }

    .nav-item.active { background: #1d4ed8; }
    .nav-item:hover { background: #111827; }

    .logout {
      margin-top: auto;
      font-size: 13px;
      color: #f97373;
      cursor: pointer;
    }

    /* MAIN */
    .main {
      flex: 1;
      padding: 24px 32px;
    }

    .topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }

    .topbar h1 { margin: 0; font-size: 22px; }
    .topbar small { color: #6b7280; }
    .welcome { font-size: 14px; color: #374151; }

    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .page-header h2 { margin: 0; font-size: 22px; }
    .page-header p { margin: 4px 0 0; font-size: 13px; color: #6b7280; }

    .header-buttons {
      display: flex;
      gap: 10px;
    }

    .btn-primary {
      padding: 8px 16px;
      border-radius: 999px;
      border: none;
      background: #1d4ed8;
      color: #fff;
      font-weight: 500;
      font-size: 14px;
      cursor: pointer;
    }

    .btn-primary:hover { background: #1e40af; }

    .tabs {
      display: inline-flex;
      background: #e5e7eb;
      border-radius: 999px;
      padding: 2px;
      margin-bottom: 12px;
    }

    .tab {
      padding: 6px 14px;
      border-radius: 999px;
      font-size: 13px;
      cursor: pointer;
      border: none;
      background: transparent;
      color: #374151;
    }

    .tab.active {
      background: #ffffff;
      box-shadow: 0 1px 3px rgba(15, 23, 42, 0.15);
    }

    .card {
      background: #fff;
      border-radius: 12px;
      padding: 16px 18px;
      box-shadow: 0 8px 20px rgba(15,23,42,0.08);
    }

    .project-row {
      padding: 10px 0;
      border-bottom: 1px solid #e5e7eb;
    }

    .project-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }

    .project-title {
      font-weight: 600;
      font-size: 14px;
    }

    .project-meta {
      font-size: 12px;
      color: #6b7280;
    }

    .badge-status {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
    }

    .badge-aktiv {
      background: #dcfce7;
      color: #166534;
    }

    .badge-avslutad {
      background: #fee2e2;
      color: #b91c1c;
    }

    .project-actions {
      display: flex;
      gap: 6px;
    }

    .btn-small {
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      background: #fff;
      font-size: 11px;
      cursor: pointer;
    }

    .btn-small.danger {
      border-color: #f97373;
      color: #b91c1c;
    }

    .sub-list-title {
      font-size: 12px;
      color: #6b7280;
      margin-top: 4px;
    }

    .sub-list {
      font-size: 12px;
      margin: 2px 0 0;
      padding-left: 16px;
      color: #4b5563;
    }

    .empty-text {
      font-size: 13px;
      color: #6b7280;
      margin-top: 8px;
    }

    /* MODALER */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.55);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }

    .modal {
      width: 100%;
      max-width: 520px;
      background: #ffffff;
      border-radius: 18px;
      padding: 24px 24px 20px;
      box-shadow: 0 24px 50px rgba(15,23,42,0.35);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .modal-header h3 { margin: 0; font-size: 18px; }

    .modal-close {
      border: none;
      background: transparent;
      font-size: 20px;
      cursor: pointer;
      color: #6b7280;
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 13px;
      margin-bottom: 10px;
    }

    .field label { color: #374151; }

    .field input,
    .field select,
    .field textarea {
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      font-size: 13px;
      resize: vertical;
    }

    .field textarea { min-height: 70px; }

    .field input:focus,
    .field select:focus,
    .field textarea:focus {
      outline: none;
      border-color: #2563eb;
      box-shadow: 0 0 0 1px #2563eb25;
    }

    .modal-footer {
      margin-top: 16px;
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }

    .btn-secondary {
      padding: 8px 16px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      background: #fff;
      cursor: pointer;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <!-- SIDEBAR -->
  <aside class="sidebar">
    <h2>Admina Bas</h2>

    <div class="nav-section">
      <a href="dashboard.html" class="nav-item">Översikt</a>
      <a href="tidrapporter.html" class="nav-item">Tidrapporter</a>
      <a href="#" class="nav-item">Planering</a>
      <a href="#" class="nav-item">Avvikelser</a>
      <a href="#" class="nav-item">Lönöversikt</a>
      <a href="#" class="nav-item">Kontakter</a>
    </div>

    <div class="nav-section-title">Administration</div>
    <a href="admin.html" class="nav-item">Attestering</a>
    <a href="projects.html" class="nav-item active">Projekt</a>

    <div class="logout" id="logoutBtn">⬅ Logga ut</div>
  </aside>

  <!-- MAIN -->
  <main class="main">
    <div class="topbar">
      <div>
        <h1>Rail Work AB</h1>
        <small>Projekt & underprojekt</small>
      </div>
      <div class="welcome">Välkommen, admin</div>
    </div>

    <div class="page-header">
      <div>
        <h2>Projekt & Underprojekt</h2>
        <p>Hantera projekt och underprojekt som kan väljas vid tidrapportering och attestering.</p>
      </div>
      <div class="header-buttons">
        <button class="btn-primary" id="newProjectBtn">+ Nytt projekt</button>
        <button class="btn-primary" id="newSubprojectBtn">+ Nytt underprojekt</button>
      </div>
    </div>

    <div class="tabs">
      <button class="tab active" id="tabActive">Aktiva projekt (<span id="activeCount">0</span>)</button>
      <button class="tab" id="tabEnded">Avslutade projekt (<span id="endedCount">0</span>)</button>
    </div>

    <div class="card">
      <div id="projectsContainer"></div>
      <div id="projectsEmpty" class="empty-text">
        Inga projekt upplagda ännu. Klicka på <strong>Nytt projekt</strong> för att lägga till.
      </div>
    </div>
  </main>

  <!-- MODAL: NYTT PROJEKT -->
  <div class="modal-backdrop" id="projectModalBackdrop">
    <div class="modal">
      <div class="modal-header">
        <h3>Nytt projekt</h3>
        <button class="modal-close" id="closeProjectModal">&times;</button>
      </div>

      <form id="projectForm">
        <div class="field">
          <label for="projectName">Projektnamn *</label>
          <input id="projectName" required placeholder="T.ex. Renovering kontor" />
        </div>

        <div class="field">
          <label for="projectCustomer">Kund</label>
          <input id="projectCustomer" placeholder="Kundnamn" />
        </div>

        <div class="field">
          <label for="projectTask">Arbetsuppgift</label>
          <input id="projectTask" placeholder="T.ex. Elinstallation" />
        </div>

        <div class="field">
          <label for="projectLocation">Plats</label>
          <input id="projectLocation" placeholder="T.ex. Stockholm Central" />
        </div>

        <div class="field">
          <label for="projectCode">Intern märkning (visas på export/attestering)</label>
          <input id="projectCode" placeholder="T.ex. PRJ-2024-001" />
        </div>

        <div class="field">
          <label for="projectDescription">Beskrivning</label>
          <textarea id="projectDescription" placeholder="Ytterligare information om projektet..."></textarea>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn-secondary" id="cancelProjectBtn">Avbryt</button>
          <button type="submit" class="btn-primary">Skapa projekt</button>
        </div>
      </form>
    </div>
  </div>

  <!-- MODAL: NYTT UNDERPROJEKT -->
  <div class="modal-backdrop" id="subModalBackdrop">
    <div class="modal">
      <div class="modal-header">
        <h3>Nytt underprojekt</h3>
        <button class="modal-close" id="closeSubModal">&times;</button>
      </div>

      <form id="subForm">
        <div class="field">
          <label for="subProjectSelect">Projekt</label>
          <select id="subProjectSelect"></select>
        </div>

        <div class="field">
          <label for="subName">Namn</label>
          <input id="subName" placeholder="Namn på underprojekt" />
        </div>

        <div class="field">
          <label for="subDescription">Beskrivning</label>
          <textarea id="subDescription" placeholder="Kort beskrivning..."></textarea>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn-secondary" id="cancelSubBtn">Avbryt</button>
          <button type="submit" class="btn-primary">Skapa underprojekt</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    const PROJECTS_KEY = "projects";
    const SUBPROJECTS_KEY = "subProjects";

    const token = localStorage.getItem("token");
    if (!token) {
      window.location.href = "login.html";
    }

    document.getElementById("logoutBtn").addEventListener("click", () => {
      localStorage.removeItem("token");
      window.location.href = "login.html";
    });

    let projects = JSON.parse(localStorage.getItem(PROJECTS_KEY) || "[]");
    let subProjects = JSON.parse(localStorage.getItem(SUBPROJECTS_KEY) || "[]");

    function saveProjects() {
      localStorage.setItem(PROJECTS_KEY, JSON.stringify(projects));
    }
    function saveSubProjects() {
      localStorage.setItem(SUBPROJECTS_KEY, JSON.stringify(subProjects));
    }

    const tabActive = document.getElementById("tabActive");
    const tabEnded = document.getElementById("tabEnded");
    const projectsContainer = document.getElementById("projectsContainer");
    const projectsEmpty = document.getElementById("projectsEmpty");
    const activeCountSpan = document.getElementById("activeCount");
    const endedCountSpan = document.getElementById("endedCount");

    let currentTab = "aktiv"; // eller "avslutad"

    function openModal(backdrop) {
      backdrop.style.display = "flex";
    }

    function closeModal(backdrop) {
      backdrop.style.display = "none";
    }

    // Projekt-modal
    const projectModalBackdrop = document.getElementById("projectModalBackdrop");
    const newProjectBtn = document.getElementById("newProjectBtn");
    const closeProjectModal = document.getElementById("closeProjectModal");
    const cancelProjectBtn = document.getElementById("cancelProjectBtn");
    const projectForm = document.getElementById("projectForm");

    newProjectBtn.addEventListener("click", () => openModal(projectModalBackdrop));
    closeProjectModal.addEventListener("click", () => closeModal(projectModalBackdrop));
    cancelProjectBtn.addEventListener("click", () => closeModal(projectModalBackdrop));
    projectModalBackdrop.addEventListener("click", (e) => {
      if (e.target === projectModalBackdrop) closeModal(projectModalBackdrop);
    });

    projectForm.addEventListener("submit", (e) => {
      e.preventDefault();
      const name = document.getElementById("projectName").value.trim();
      if (!name) {
        alert("Ange projektnamn.");
        return;
      }

      const project = {
        id: Date.now().toString(),
        name,
        customer: document.getElementById("projectCustomer").value.trim(),
        task: document.getElementById("projectTask").value.trim(),
        location: document.getElementById("projectLocation").value.trim(),
        code: document.getElementById("projectCode").value.trim(),
        description: document.getElementById("projectDescription").value.trim(),
        status: "aktiv"
      };

      projects.push(project);
      saveProjects();
      projectForm.reset();
      closeModal(projectModalBackdrop);
      render();
    });

    // Underprojekt-modal
    const subModalBackdrop = document.getElementById("subModalBackdrop");
    const newSubprojectBtn = document.getElementById("newSubprojectBtn");
    const closeSubModal = document.getElementById("closeSubModal");
    const cancelSubBtn = document.getElementById("cancelSubBtn");
    const subForm = document.getElementById("subForm");
    const subProjectSelect = document.getElementById("subProjectSelect");

    function reloadProjectSelect() {
      subProjectSelect.innerHTML = "";
      projects
        .filter(p => p.status === "aktiv")
        .forEach(p => {
          const opt = document.createElement("option");
          opt.value = p.id;
          opt.textContent = p.name;
          subProjectSelect.appendChild(opt);
        });
    }

    newSubprojectBtn.addEventListener("click", () => {
      reloadProjectSelect();
      openModal(subModalBackdrop);
    });

    closeSubModal.addEventListener("click", () => closeModal(subModalBackdrop));
    cancelSubBtn.addEventListener("click", () => closeModal(subModalBackdrop));
    subModalBackdrop.addEventListener("click", (e) => {
      if (e.target === subModalBackdrop) closeModal(subModalBackdrop);
    });

    subForm.addEventListener("submit", (e) => {
      e.preventDefault();
      if (!projects.length) {
        alert("Skapa ett projekt först.");
        return;
      }
      const projectId = subProjectSelect.value;
      const name = document.getElementById("subName").value.trim();
      if (!name) {
        alert("Ange namn på underprojekt.");
        return;
      }

      const sp = {
        id: Date.now().toString(),
        projectId,
        name,
        description: document.getElementById("subDescription").value.trim()
      };

      subProjects.push(sp);
      saveSubProjects();
      subForm.reset();
      closeModal(subModalBackdrop);
      render();
    });

    // Tabs
    tabActive.addEventListener("click", () => {
      currentTab = "aktiv";
      tabActive.classList.add("active");
      tabEnded.classList.remove("active");
      render();
    });
    tabEnded.addEventListener("click", () => {
      currentTab = "avslutad";
      tabActive.classList.remove("active");
      tabEnded.classList.add("active");
      render();
    });

    function render() {
      projectsContainer.innerHTML = "";

      const activeProjects = projects.filter(p => p.status === "aktiv");
      const endedProjects = projects.filter(p => p.status === "avslutad");

      activeCountSpan.textContent = activeProjects.length;
      endedCountSpan.textContent = endedProjects.length;

      const list = currentTab === "aktiv" ? activeProjects : endedProjects;

      projectsEmpty.style.display = list.length ? "none" : "block";

      list.forEach((p) => {
        const row = document.createElement("div");
        row.className = "project-row";

        const subForProject = subProjects.filter(sp => sp.projectId === p.id);

        row.innerHTML = `
          <div class="project-header">
            <div>
              <div class="project-title">${p.name}</div>
              <div class="project-meta">
                ${p.customer ? p.customer + " · " : ""}
                ${p.task ? p.task + " · " : ""}
                ${p.location || ""}
                ${p.code ? " · " + p.code : ""}
              </div>
            </div>
            <div class="project-actions">
              <span class="badge-status ${
                p.status === "aktiv" ? "badge-aktiv" : "badge-avslutad"
              }">
                ${p.status === "aktiv" ? "Aktivt" : "Avslutat"}
              </span>
              <button class="btn-small" data-action="toggle">${
                p.status === "aktiv" ? "Avsluta" : "Återöppna"
              }</button>
              <button class="btn-small danger" data-action="delete">Ta bort</button>
            </div>
          </div>
          ${
            p.description
              ? `<div class="project-meta">${p.description}</div>`
              : ""
          }
          <div class="sub-list-title">
            Underprojekt (${subForProject.length})
          </div>
          <ul class="sub-list">
            ${
              subForProject.length
                ? subForProject
                    .map(
                      (sp) =>
                        `<li>${sp.name}${
                          sp.description ? " – " + sp.description : ""
                        }</li>`
                    )
                    .join("")
                : "<li>Inga underprojekt</li>"
            }
          </ul>
        `;

        const toggleBtn = row.querySelector('button[data-action="toggle"]');
        const deleteBtn = row.querySelector('button[data-action="delete"]');

        toggleBtn.addEventListener("click", () => {
          p.status = p.status === "aktiv" ? "avslutad" : "aktiv";
          saveProjects();
          render();
        });

        deleteBtn.addEventListener("click", () => {
          if (!confirm("Ta bort projektet och alla dess underprojekt?")) return;
          projects = projects.filter(pr => pr.id !== p.id);
          subProjects = subProjects.filter(sp => sp.projectId !== p.id);
          saveProjects();
          saveSubProjects();
          render();
        });

        projectsContainer.appendChild(row);
      });
    }

    render();
  </script>
</body>
</html>
