<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <title>Rail Work AB ‚Äì Attestering</title>
  <style>
    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      background: #f3f4f6;
    }

    .sidebar {
      width: 240px;
      background: #0f172a;
      color: #e5e7eb;
      padding: 16px 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .sidebar h2 {
      font-size: 18px;
      margin: 0 0 16px;
    }

    .nav-section-title {
      font-size: 11px;
      text-transform: uppercase;
      opacity: 0.6;
      margin-top: 12px;
    }

    /* Adminhub dropdown */
    .admin-hub {
      display: flex;
      flex-direction: column;
      gap: 6px;
      position: relative;
    }

    .nav-section-toggle {
      background: transparent;
      border: none;
      color: inherit;
      text-align: left;
      padding: 8px 10px;
      font-size: 13px;
      cursor: pointer;
      border-radius: 8px;
    }

    .nav-section-toggle:hover { background: rgba(255,255,255,0.03); }

    .admin-submenu {
      /* keep submenu in document flow so it pushes following items down */
      display: flex;
      position: relative;
      left: 0;
      min-width: 100%;
      background: #0b1220;
      color: #e5e7eb;
      border-radius: 10px;
      padding: 8px 10px;
      box-shadow: 0 10px 30px rgba(2,6,23,0.6);
      flex-direction: column;
      gap: 8px;
      max-height: 0;
      overflow: hidden;
      transform-origin: top left;
      transform: translateY(-6px);
      transition: max-height 180ms ease, opacity 140ms ease, transform 140ms ease;
      opacity: 0;
    }

    .admin-submenu::before {
      content: "";
      position: absolute;
      top: -8px;
      left: 18px;
      width: 12px;
      height: 12px;
      background: #0b1220;
      transform: rotate(45deg);
      box-shadow: -2px -2px 6px rgba(2,6,23,0.15);
    }

    /* show on hover for pointer devices */
    .admin-hub:hover .admin-submenu { max-height: 600px; opacity: 1; transform: translateY(0); }
    /* allow explicit open via JS for touch devices */
    .admin-hub.open .admin-submenu { max-height: 600px; opacity: 1; transform: translateY(0); }

    .admin-submenu .nav-item {
      padding: 10px 12px;
      border-radius: 8px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .nav-item {
      padding: 8px 10px;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
      text-decoration: none;
      color: inherit;
      display: block;
    }

    .nav-item.active { background: #1d4ed8; }
    .nav-item:hover { background: #111827; }

    .logout {
      margin-top: auto;
      font-size: 13px;
      color: #f97373;
      cursor: pointer;
    }

    .main { flex: 1; padding: 24px 32px; }

    .topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }

    .topbar h1 { margin: 0; font-size: 22px; }
    .topbar small { color: #6b7280; }
    .welcome { font-size: 14px; color: #374151; }

    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .page-header h2 { margin: 0; font-size: 20px; }
    .page-header p { margin: 4px 0 0; font-size: 13px; color: #6b7280; }

    .btn-secondary {
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      background: #fff;
      cursor: pointer;
      font-size: 13px;
    }

    .btn-secondary:hover { background: #f3f4f6; }

    .card {
      background: #fff;
      border-radius: 12px;
      padding: 16px 18px;
      box-shadow: 0 8px 20px rgba(15, 23, 42, 0.08);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }

    th, td {
      padding: 8px 10px;
      border-bottom: 1px solid #e5e7eb;
      text-align: left;
      vertical-align: top;
    }

    th {
      font-size: 11px;
      text-transform: uppercase;
      color: #6b7280;
    }

    .actions {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      align-items: center;
      justify-content: flex-end;
    }
    .actions .btn-small {
      padding: 6px 10px;
      border-radius: 10px;
      border: 1px solid #d1d5db;
      background: #fff;
      font-size: 12px;
      font-weight: 600;
    }
    .actions .btn-small.edit { background: #e0e7ff; color: #1d4ed8; border-color: #c7d2fe; }
    .actions .btn-small.attest { background: #e0f2fe; color: #075985; border-color: #bfdbfe; }
    .actions .btn-small.delete { background: #fee2e2; color: #b91c1c; border-color: #fecdd3; }
    .actions .btn-small.save { background: #dcfce7; color: #166534; border-color: #bbf7d0; }
    .actions .btn-small.view-comment { background: #f8fafc; color: #0f172a; border-color: #e2e8f0; }

    .name-input {
      width: 120px;
      padding: 4px 6px;
      border-radius: 6px;
      border: 1px solid #d1d5db;
      font-size: 12px;
    }

    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
    }

    .status-ny {
      background: #fee2e2;
      color: #b91c1c;
    }

    .status-attesterad {
      background: #dcfce7;
      color: #166534;
    }

    .actions {
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
    }

    .btn-small {
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      background: #fff;
      font-size: 11px;
      cursor: pointer;
    }

    .btn-small.attest {
      border-color: #22c55e;
      color: #15803d;
    }

    .btn-small.delete {
      border-color: #f87171;
      color: #b91c1c;
    }

    .badge-empty {
      font-size: 13px;
      color: #6b7280;
      margin-top: 8px;
    }

    .filters {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 12px;
      font-size: 12px;
    }

    .filters label {
      display: flex;
      flex-direction: column;
      gap: 2px;
      color: #374151;
    }

    .filters select {
      min-width: 150px;
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      font-size: 12px;
      background: #fff;
    }

    .filters button {
      align-self: flex-end;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      background: #fff;
      cursor: pointer;
      font-size: 12px;
    }

    .filters button:hover {
      background: #f3f4f6;
    }

    .view-toggle {
      display: flex;
      gap: 6px;
      align-items: center;
      margin-left: auto;
    }
    .view-toggle button {
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      background: #fff;
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
    }
    .view-toggle button.active {
      background: #1d4ed8;
      color: #fff;
      border-color: #1d4ed8;
    }

    /* Mobil app-liknande kort */
    .mobile-cards {
      display: none;
      margin-top: 12px;
      display: none;
      flex-direction: column;
      gap: 12px;
    }

    .mobile-card {
      border-radius: 14px;
      background: #facc15;
      color: #111827;
      padding: 12px 14px;
      box-shadow: 0 10px 20px rgba(0,0,0,0.08);
    }

    .mobile-card header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: 700;
      font-size: 14px;
    }

    .mobile-card .pill {
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 12px;
      font-weight: 700;
      background: #0f172a;
      color: #facc15;
    }

    .mobile-card .row {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      font-size: 13px;
      margin-top: 6px;
      border-bottom: 1px solid rgba(15,23,42,0.15);
      padding-bottom: 4px;
    }

    .mobile-card .row:last-of-type {
      border-bottom: none;
    }

    .mobile-card .label {
      font-weight: 700;
      color: #0f172a;
    }

    .mobile-card .value {
      font-weight: 600;
      text-align: right;
    }

    .mobile-card .actions {
      margin-top: 8px;
      justify-content: flex-start;
    }

    /* Mobilanpassning */
    @media (max-width: 768px) {
      .filters {
        flex-direction: column;
        align-items: stretch;
      }
      .filters label {
        width: 100%;
      }
      table {
        border: 0;
      }
      thead {
        display: none;
      }
      tr {
        display: block;
        margin-bottom: 14px;
        box-shadow: 0 8px 18px rgba(15,23,42,0.08);
        border-radius: 12px;
        background: #fff;
        padding: 10px 12px;
      }
      td {
        display: flex;
        justify-content: space-between;
        gap: 10px;
        border: none;
        padding: 6px 0;
      }
      td::before {
        content: attr(data-label);
        font-weight: 600;
        color: #6b7280;
      }
      .actions {
        justify-content: flex-start;
      }

      /* D√∂lj tabellen och visa kort n√§r mobile-mode √§r aktiv */
      body.mobile-mode table {
        display: none;
      }
      body.mobile-mode .mobile-cards {
        display: flex;
      }
    }
  </style>
</head>
<body>
<!-- SIDEBAR -->
<aside class="sidebar">
  <h2>Admina Bas</h2>

  <div class="nav-section">
    <a href="dashboard.html" class="nav-item">√ñversikt</a>
    <a href="tidrapporter.html" class="nav-item">Tidrapporter</a>
      <a href="planning.html" class="nav-item">Planering</a>
      <a href="deviations.html" class="nav-item">Avvikelser</a>
      <a href="svetsrapport.html" class="nav-item">Svetsrapport</a>
      <a href="salary-overview.html" class="nav-item">L√∂n√∂versikt</a>
      <a href="contacts.html" class="nav-item">Kontakter</a>
  </div>

    <div class="nav-section-title admin-only">Administration</div>
    <a href="administration.html" class="nav-item admin-only">AdminHub</a>
    <a href="admin.html" class="nav-item admin-only active">Attestering</a>
    <a href="projects.html" class="nav-item admin-only">Projekt</a>
    <a href="job_roles.html" class="nav-item admin-only">Yrkesroller</a>
    <a href="material_types.html" class="nav-item admin-only">Materialtyper</a>
    <a href="ob_settings.html" class="nav-item admin-only">OB-inst√§llningar</a>
    <a href="planning-admin.html" class="nav-item admin-only">Planering</a>
    <a href="admin-users.html" class="nav-item admin-only">Anv√§ndare</a>

    <div style="margin-top:auto; display:flex; flex-direction:column; gap:8px;">
      <div class="view-toggle" style="justify-content:flex-start;">
        <button type="button" id="mobileViewBtnSidebar">Mobilvy</button>
        <button type="button" id="tableViewBtnSidebar" class="active">Tabellvy</button>
      </div>
      <div class="logout" id="logoutBtn">‚¨Ö Logga ut</div>
    </div>
  </aside>

<!-- MAIN -->
<main class="main">
  <div class="topbar">
    <div>
      <h1>Rail Work AB</h1>
      <small>Attestering av tidrapporter</small>
    </div>
    <div class="welcome" id="welcomeText">V√§lkommen</div>
  </div>

  <div class="page-header">
    <div>
      <h2>Attestering av tidrapporter</h2>
      <p>
        V√§lj projekt, underprojekt och anv√§ndare f√∂r att attestera r√§tt rader.
        N√§r en rad √§r attesterad l√•ses den f√∂r anv√§ndaren.
      </p>
    </div>
    <button class="btn-secondary" id="downloadPdfBtn">Exportera PDF (attesterade)</button>
  </div>

  <div class="card">
    <!-- FILTERS -->
    <div class="filters">
      <label>
        Anv√§ndare
        <select id="filterUser">
          <option value="">Alla anv√§ndare</option>
        </select>
      </label>

      <label>
        Kund
        <select id="filterCustomer">
          <option value="">Alla kunder</option>
        </select>
      </label>

      <label>
        Projekt
        <select id="filterProject">
          <option value="">Alla projekt</option>
        </select>
      </label>

      <label>
        Underprojekt
        <select id="filterSubproject">
          <option value="">Alla underprojekt</option>
        </select>
      </label>

      <label>
        Status
        <select id="filterStatus">
          <option value="">Alla</option>
          <option value="Ny">Ny</option>
          <option value="Attesterad">Attesterad</option>
        </select>
      </label>

      <button id="clearFiltersBtn">Rensa filter</button>
      <div class="view-toggle">
        <button type="button" id="mobileViewBtn">Mobilvy</button>
        <button type="button" id="tableViewBtn" class="active">Tabellvy</button>
      </div>
    </div>

  <div id="mobileCards" class="mobile-cards"></div>

  <table>
    <thead>
      <tr>
        <th>Datum</th>
        <th>Anv√§ndare</th>
        <th>Kund</th>
          <th>Projekt</th>
          <th>Underprojekt</th>
          <th>Avvikelser</th>
          <th>Kommentar</th>
          <th>Start</th>
          <th>Slut</th>
          <th>Totalt (h)</th>
          <th>OB dag</th>
          <th>OB kv√§ll</th>
          <th>OB natt</th>
          <th>OB helg</th>
          <th>Restid</th>
          <th>Status</th>
          <th>√Ötg√§rder</th>
        </tr>
      </thead>
      <tbody id="reportsBody"></tbody>
    </table>
    <div id="emptyState" class="badge-empty">
      Inga tidrapporter hittades. Be anv√§ndarna rapportera tid p√• sidan <strong>Tidrapporter</strong>.
    </div>
  </div>
</main>

<script src="auth.js"></script>
<script>
  (function syncUser() {
    const raw = localStorage.getItem("user");
    if (raw && !localStorage.getItem("currentUser")) {
      try {
        const u = JSON.parse(raw);
        const mapped = {
          ...u,
          firstName: u.firstName || u.first_name || "",
          lastName: u.lastName || u.last_name || ""
        };
        setCurrentUser(mapped);
      } catch (e) {}
    }
  })();

  const currentUser = requireLogin();
  setupSidebarForUser(currentUser);

  if (!isAdmin(currentUser)) {
    alert("Endast admin har √•tkomst till denna sida.");
    window.location.href = "dashboard.html";
  }

  document.getElementById("logoutBtn").addEventListener("click", () => {
    localStorage.removeItem("token");
    localStorage.removeItem("currentUser");
    localStorage.removeItem("user");
    window.location.href = "login.html";
  });

  const STORAGE_KEY = "timeReports"; // kept for backward compatibility
  const PROJECTS_KEY = "projects";
  const SUBPROJECTS_KEY = "subProjects";
  const DEVIATIONS_KEY = "deviations";

  let reports = [];
  let projects = JSON.parse(localStorage.getItem(PROJECTS_KEY) || "[]");
  let subProjects = JSON.parse(localStorage.getItem(SUBPROJECTS_KEY) || "[]");
  let deviations = [];

  const API_TOKEN = localStorage.getItem("token") || null;

  function saveReports() {
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(reports));
    } catch (e) {
      console.warn("Kunde inte spara lokalt fallback:", e);
    }
  }

  function loadDeviations() {
    try {
      deviations = JSON.parse(localStorage.getItem(DEVIATIONS_KEY) || "[]");
    } catch {
      deviations = [];
    }
  }

  function apiFetch(path, opts = {}) {
    opts.headers = opts.headers || {};
    if (API_TOKEN) opts.headers["Authorization"] = `Bearer ${API_TOKEN}`;
    if (opts.body && typeof opts.body === "object" && !(opts.body instanceof FormData)) {
      opts.headers["Content-Type"] = "application/json";
      opts.body = JSON.stringify(opts.body);
    }
    return fetch(path, opts).then((r) => r.json().catch(() => ({})));
  }

  // Load reports from backend (admin sees all)
  async function loadReportsFromServer() {
    let loaded = [];
    try {
      const res = await fetch("/time-reports", {
        headers: API_TOKEN ? { Authorization: `Bearer ${API_TOKEN}` } : {}
      });
      if (!res.ok) {
        console.error("Kunde inte h√§mta tidrapporter fr√•n servern", res.status);
        loaded = [];
      } else {
        loaded = await res.json();
      }
    } catch (e) {
      console.error("Network error n√§r tidrapporter h√§mtades:", e);
      loaded = [];
    }

    // Om inget kom fr√•n servern, fall tillbaka p√• lokalt sparade rapporter
    if (!Array.isArray(loaded) || loaded.length === 0) {
      loaded = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
    }

    reports = loaded;

    // Normalisera och defaults
    reports.forEach((r) => {
      if (!r.status) r.status = "Ny";
      if (!r.userName && r.user_name) r.userName = r.user_name;
      if (r.restid === undefined) r.restid = 0;
      if (r.rast === undefined) r.rast = 0;
    });

    buildFilterOptions();
    loadDeviations();
    render();
  }

  function parseDate(dateStr) {
    const [y, m, d] = (dateStr || "").split("-").map(Number);
    if (!y || !m || !d) return new Date();
    return new Date(y, m - 1, d);
  }

  function calcHours(report) {
    const fallback = parseFloat(report.timmar || report.hours || "0");
    if (!Number.isNaN(fallback) && fallback > 0) {
      return fallback;
    }

    const dateStr = report.datum || report.date;
    const startStr = report.starttid || report.start;
    const endStr = report.sluttid || report.end;
    if (!dateStr || !startStr || !endStr) return 0;

    const [sh, sm] = startStr.split(":").map(Number);
    const [eh, em] = endStr.split(":").map(Number);

    const startDate = new Date(dateStr);
    startDate.setHours(sh || 0, sm || 0, 0, 0);

    const endDate = new Date(dateStr);
    endDate.setHours(eh || 0, em || 0, 0, 0);

    if (endDate <= startDate) {
      endDate.setDate(endDate.getDate() + 1);
    }

    const diffMinutes = (endDate - startDate) / 60000;
    const roundedMinutes = Math.round(diffMinutes / 10) * 10; // 10-minuterssteg
    const roundedHours = roundedMinutes / 60;

    return roundedHours > 0 ? parseFloat(roundedHours.toFixed(2)) : 0;
  }

  function roundTimeToStep(timeStr, stepMinutes = 10) {
    if (!timeStr) return "";
    const [h, m] = timeStr.split(":").map(Number);
    if (Number.isNaN(h) || Number.isNaN(m)) return "";
    const totalMinutes = h * 60 + m;
    const rounded = Math.round(totalMinutes / stepMinutes) * stepMinutes;
    const rHours = Math.floor(rounded / 60) % 24;
    const rMinutes = rounded % 60;
    return `${String(rHours).padStart(2, "0")}:${String(rMinutes).padStart(2, "0")}`;
  }

  function getObCategory(dateObj) {
    const dow = dateObj.getDay();
    const hour = dateObj.getHours();

    // Helg: fre 18:00 -> m√•n 06:00
    if (
      (dow === 5 && hour >= 18) ||
      dow === 6 ||
      dow === 0 ||
      (dow === 1 && hour < 6)
    ) {
      return "helg";
    }
    if (hour >= 21 || hour < 6) return "natt";
    if (hour >= 18 && hour < 21) return "kv√§ll";
    return "dag";
  }

  function splitObHours(report) {
    const result = { dag: 0, kv√§ll: 0, natt: 0, helg: 0 };
    if (!report.datum || !report.starttid || !report.sluttid) return result;

    const [sh, sm] = report.starttid.split(":").map(Number);
    const [eh, em] = report.sluttid.split(":").map(Number);

    let startDate = parseDate(report.datum);
    startDate.setHours(sh || 0, sm || 0, 0, 0);

    let endDate = parseDate(report.datum);
    endDate.setHours(eh || 0, em || 0, 0, 0);

    if (endDate <= startDate) {
      endDate.setDate(endDate.getDate() + 1);
    }

    const stepMinutes = 15;
    let cursor = new Date(startDate);

    while (cursor < endDate) {
      const cat = getObCategory(cursor);
      result[cat] += stepMinutes / 60;
      cursor = new Date(cursor.getTime() + stepMinutes * 60000);
    }

    return result;
  }

  function toggleEmptyState(hasRows) {
    document.getElementById("emptyState").style.display =
      hasRows ? "none" : "block";
  }

  const tbody = document.getElementById("reportsBody");
  const mobileCards = document.getElementById("mobileCards");
  const filterUser = document.getElementById("filterUser");
  const filterCustomer = document.getElementById("filterCustomer");
  const filterProject = document.getElementById("filterProject");
  const filterSubproject = document.getElementById("filterSubproject");
  const filterStatus = document.getElementById("filterStatus");
  const clearFiltersBtn = document.getElementById("clearFiltersBtn");
  const mobileViewBtn = document.getElementById("mobileViewBtn");
  const tableViewBtn = document.getElementById("tableViewBtn");
  const mobileViewBtnSidebar = document.getElementById("mobileViewBtnSidebar");
  const tableViewBtnSidebar = document.getElementById("tableViewBtnSidebar");

  function buildFilterOptions() {
    // Anv√§ndare
    const userSet = new Set();
    reports.forEach((r) => {
      if (r.userName && r.userName.trim() !== "") {
        userSet.add(r.userName.trim());
      }
    });
    filterUser.innerHTML = '<option value="">Alla anv√§ndare</option>';
    [...userSet].sort().forEach((name) => {
      const opt = document.createElement("option");
      opt.value = name;
      opt.textContent = name;
      filterUser.appendChild(opt);
    });

    // Om admin finns en mer auktoritativ lista av anv√§ndare p√• servern ‚Äî anv√§nd den
    try {
      const prevUserValue = filterUser.value;
      if (API_TOKEN && isAdmin(currentUser)) {
        apiFetch("/admin/users")
          .then((users) => {
            if (!Array.isArray(users)) return;
            filterUser.innerHTML = '<option value="">Alla anv√§ndare</option>';
            users.forEach((u) => {
              const name = ((u.first_name || u.firstName || "") + " " + (u.last_name || u.lastName || "")).trim();
              const display = name || u.email || u.username || (u.id ? String(u.id) : "");
              const opt = document.createElement("option");
              opt.value = display;
              opt.textContent = display;
              filterUser.appendChild(opt);
            });
            if (prevUserValue) filterUser.value = prevUserValue;
          })
          .catch((e) => {
            console.warn("Kunde inte h√§mta admin/users f√∂r filter:", e);
          });
      }
    } catch (e) {
      console.warn("Fel vid uppdatering av user-filter:", e);
    }

    // Projekt
    projects = JSON.parse(localStorage.getItem(PROJECTS_KEY) || "[]");
    subProjects = JSON.parse(localStorage.getItem(SUBPROJECTS_KEY) || "[]");

    const currentProjValue = filterProject.value;
    const currentCustomerValue = filterCustomer.value;
    const currentSubValue = filterSubproject.value;

    // Kunder
    const customerSet = new Set();
    projects.forEach((p) => {
      if (p.customer || p.customer_name) {
        customerSet.add(p.customer || p.customer_name);
      }
    });
    filterCustomer.innerHTML = '<option value="">Alla kunder</option>';
    [...customerSet].sort().forEach((cust) => {
      const opt = document.createElement("option");
      opt.value = cust;
      opt.textContent = cust;
      filterCustomer.appendChild(opt);
    });
    if (currentCustomerValue) filterCustomer.value = currentCustomerValue;

    filterProject.innerHTML = '<option value="">Alla projekt</option>';
    projects.forEach((p) => {
      const opt = document.createElement("option");
      opt.value = p.id;
      opt.textContent = p.name;
      filterProject.appendChild(opt);
    });
    if (currentProjValue) filterProject.value = currentProjValue;

    // Underprojekt
    filterSubproject.innerHTML =
      '<option value="">Alla underprojekt</option>';
    subProjects.forEach((sp) => {
      const opt = document.createElement("option");
      opt.value = sp.id;
      opt.textContent = sp.name;
      filterSubproject.appendChild(opt);
    });
    if (currentSubValue) filterSubproject.value = currentSubValue;
  }

  function getProjectName(r) {
    return (
      r.projectName ||
      (r.projectId && (projects.find((p) => p.id === r.projectId) || {}).name) ||
      r.projekt ||
      "-"
    );
  }

  function getCustomerName(r) {
    let proj =
      (r.projectId && projects.find((p) => p.id === r.projectId)) || null;
    if (!proj && r.projectName) {
      proj = projects.find((p) => (p.name || "").trim() === (r.projectName || "").trim()) || null;
    }
    return (
      (proj && (proj.customer || proj.customer_name)) ||
      r.customer ||
      r.customer_name ||
      ""
    );
  }

  function getSubProjectName(r) {
    return (
      r.subProjectName ||
      (r.subProjectId &&
        (subProjects.find((sp) => sp.id === r.subProjectId) || {}).name) ||
      ""
    );
  }

  function getFilteredReports() {
    const userVal = filterUser.value;
    const customerVal = filterCustomer.value;
    const projVal = filterProject.value;
    const subVal = filterSubproject.value;
    const statusVal = filterStatus.value;

    return reports.filter((r) => {
      const matchesUser =
        !userVal || (r.userName || "").trim() === userVal;
      const matchesCustomer =
        !customerVal || getCustomerName(r) === customerVal;
      const matchesProject = !projVal || r.projectId === projVal;
      const matchesSub = !subVal || r.subProjectId === subVal;
      const matchesStatus = !statusVal || r.status === statusVal;

      return (
        matchesUser &&
        matchesCustomer &&
        matchesProject &&
        matchesSub &&
        matchesStatus
      );
    });
  }

  function getDeviationsForReport(r) {
    return deviations.filter((d) => {
      const sameReport = d.reportId && String(d.reportId) === String(r.id);
      const sameProject =
        d.projectId &&
        r.projectId &&
        String(d.projectId) === String(r.projectId);
    return sameReport || sameProject;
    });
  }

  function renderMobileCards(list) {
    mobileCards.innerHTML = "";
    if (!list || !list.length) return;

    list.forEach((r) => {
      const ob = splitObHours(r);
      const totalHours = calcHours(r);
      const travel = parseFloat(r.restid || "0") || 0;
      const projectName = getProjectName(r);
      const subProjectName = getSubProjectName(r);
      const devs = getDeviationsForReport(r);
      const status = r.status === "Attesterad" ? "Attesterad" : "Ny";

      const card = document.createElement("div");
      card.className = "mobile-card";
      card.innerHTML = `
        <header>
          <div>${r.userName || "-"}</div>
          <div class="pill ${statusClass}">${status}</div>
        </header>
        <div class="row"><div class="label">Datum</div><div class="value">${r.datum || "-"}</div></div>
        <div class="row"><div class="label">Projekt</div><div class="value">${projectName}</div></div>
        <div class="row"><div class="label">Underprojekt</div><div class="value">${subProjectName || "-"}</div></div>
        <div class="row"><div class="label">Tid</div><div class="value">${r.starttid || "-"} - ${r.sluttid || "-"}</div></div>
        <div class="row"><div class="label">Totalt</div><div class="value">${totalHours.toFixed(1)} h</div></div>
        <div class="row"><div class="label">OB</div><div class="value">Dag ${ob.dag.toFixed(1)} / Kv√§ll ${ob.kv√§ll.toFixed(1)} / Natt ${ob.natt.toFixed(1)} / Helg ${ob.helg.toFixed(1)}</div></div>
        <div class="row"><div class="label">Restid</div><div class="value">${travel.toFixed(1)} h</div></div>
        <div class="row"><div class="label">Avvikelser</div><div class="value">${devs.length}</div></div>
        <div class="row"><div class="label">Kommentar</div><div class="value">${(r.comment || "-").replace(/</g, "&lt;")}</div></div>
        <div class="actions">
          <button class="btn-small edit">Redigera</button>
          <button class="btn-small save" disabled>Spara</button>
          <button class="btn-small view-comment">Se kommentar</button>
          <button class="btn-small attest">${status === "Attesterad" ? "Ta bort attest" : "Attestera"}</button>
          <button class="btn-small delete">Ta bort</button>
        </div>
      `;
      mobileCards.appendChild(card);
    });
  }

  function render() {
    tbody.innerHTML = "";

    const filtered = getFilteredReports();
    renderMobileCards(filtered);

    filtered.forEach((r) => {
      const realIndex = reports.indexOf(r);

      const ob = splitObHours(r);
      const tr = document.createElement("tr");

      const totalHours = calcHours(r);
      const travel = parseFloat(r.restid || "0") || 0;

      const projectName = getProjectName(r);
      const subProjectName = getSubProjectName(r);
      const devsForReport = getDeviationsForReport(r);
      const devCount = devsForReport.length;
      const devListHtml = devsForReport
        .slice(0, 3)
        .map(
          (d) =>
            `<div style="font-size:11px;">‚Ä¢ ${d.title || "Avvikelse"}${
              d.image ? " üì∑" : ""
            }</div>`
        )
        .join("");

      tr.innerHTML = `
        <td><input type="date" class="row-input date" value="${r.datum || ""}" disabled /></td>
        <td data-label="Anv√§ndare"><input class="row-input name-input" type="text" value="${r.userName || ""}" disabled /></td>
        <td data-label="Kund"><input class="row-input customer-input" type="text" value="${getCustomerName(r) || ""}" disabled /></td>
        <td data-label="Projekt"><input class="row-input project-input" type="text" value="${projectName}" disabled /></td>
        <td data-label="Underprojekt"><input class="row-input subproject-input" type="text" value="${subProjectName || ""}" disabled /></td>
        <td data-label="Avvikelser">
          ${devCount ? `<span class="status-badge status-ny">${devCount} st</span>${devListHtml}` : "<small>Inga</small>"}
        </td>
        <td data-label="Start"><input type="time" step="600" class="row-input start-input" value="${r.starttid || ""}" disabled /></td>
        <td data-label="Slut"><input type="time" step="600" class="row-input end-input" value="${r.sluttid || ""}" disabled /></td>
        <td data-label="Totalt (h)" class="total-hours">${totalHours.toFixed(1)}</td>
        <td data-label="OB dag">${ob.dag.toFixed(1)}</td>
        <td data-label="OB kv√§ll">${ob.kv√§ll.toFixed(1)}</td>
        <td data-label="OB natt">${ob.natt.toFixed(1)}</td>
        <td data-label="OB helg">${ob.helg.toFixed(1)}</td>
        <td data-label="Restid"><input type="number" step="0.1" min="0" class="row-input travel-input" value="${travel.toFixed(1)}" disabled /></td>
        <td data-label="Status">
          <span class="status-badge ${
            r.status === "Attesterad" ? "status-attesterad" : "status-ny"
          }">
            ${r.status === "Attesterad" ? "üîí Attesterad" : "Ny"}
          </span>
        </td>
        <td data-label="√Ötg√§rder">
          <div class="actions">
            <button class="btn-small edit">Redigera</button>
            <button class="btn-small save" disabled>Spara</button>
            <button class="btn-small view-comment">Se kommentar</button>
            <button class="btn-small attest">
              ${r.status === "Attesterad" ? "Ta bort attest" : "Attestera"}
            </button>
            <button class="btn-small delete">Ta bort</button>
          </div>
        </td>
      `;

      const attestBtn = tr.querySelector(".btn-small.attest");
      attestBtn.addEventListener("click", async () => {
        const currentStatus = reports[realIndex].status === "Attesterad" ? "Attesterad" : "Ny";
        const nextStatus = currentStatus === "Attesterad" ? "Ny" : "Attesterad";
        try {
          // F√∂rs√∂k API om det finns, men fall back till lokalt
          await apiFetch(`/time-reports/${r.id}/attest`, { method: "POST", body: { action: nextStatus === "Attesterad" ? "attest" : "unattest" } });
        } catch (e) {
          console.warn("API attest misslyckades, uppdaterar lokalt ist√§llet:", e);
        }
        reports[realIndex].status = nextStatus;
        saveReports();
        render();
      });

      const deleteBtn = tr.querySelector(".btn-small.delete");
      const viewCommentBtn = tr.querySelector(".btn-small.view-comment");
      deleteBtn.addEventListener("click", async () => {
        if (!confirm("Vill du ta bort den h√§r tidrapporten?")) return;
        try {
          await fetch(`/time-reports/${r.id}`, { method: "DELETE", headers: API_TOKEN ? { Authorization: `Bearer ${API_TOKEN}` } : {} });
        } catch (e) {
          console.warn("API delete misslyckades, tar bort lokalt:", e);
        }
        reports.splice(realIndex, 1);
        saveReports();
        buildFilterOptions();
        render();
      });

      viewCommentBtn.addEventListener("click", () => {
        const txt = (reports[realIndex].comment || "").trim();
        if (!txt) {
          alert("Ingen kommentar sparad p√• denna tidrapport.");
        } else {
          alert("Kommentar:\n\n" + txt);
        }
      });

      const editBtn = tr.querySelector(".btn-small.edit");
      const saveBtn = tr.querySelector(".btn-small.save");
      const inputs = tr.querySelectorAll(".row-input");

      function setEditing(on) {
        inputs.forEach((el) => (el.disabled = !on));
        saveBtn.disabled = !on;
        editBtn.textContent = on ? "Avbryt" : "Redigera";
        tr.dataset.editing = on ? "1" : "0";
      }
      setEditing(false);

      editBtn.addEventListener("click", () => {
        const isEditing = tr.dataset.editing === "1";
        if (isEditing) {
          render();
          return;
        }
        setEditing(true);
      });

      saveBtn.addEventListener("click", async () => {
        const dateVal = tr.querySelector(".date").value;
        const startEl = tr.querySelector(".start-input");
        const endEl = tr.querySelector(".end-input");
        const nameVal = tr.querySelector(".name-input").value.trim();
        const projectVal = tr.querySelector(".project-input").value.trim();
        const subVal = tr.querySelector(".subproject-input").value.trim();
        const travelValRaw = tr.querySelector(".travel-input").value;

        const roundedStart = roundTimeToStep(startEl.value, 10);
        const roundedEnd = roundTimeToStep(endEl.value, 10);
        startEl.value = roundedStart;
        endEl.value = roundedEnd;

        if (!dateVal || !roundedStart || !roundedEnd) {
          alert("Fyll i datum, start och slut (10-minuterssteg).");
          return;
        }

        const hoursVal = calcHours({
          datum: dateVal,
          starttid: roundedStart,
          sluttid: roundedEnd,
        });
        if (!hoursVal || hoursVal <= 0) {
          alert("Sluttid m√•ste vara efter starttid (kan g√• √∂ver midnatt).");
          return;
        }

        const travelVal = parseFloat(travelValRaw || "0") || 0;

        const payload = {
          datum: dateVal,
          starttid: roundedStart,
          sluttid: roundedEnd,
          timmar: hoursVal,
          restid: travelVal,
          user_name: nameVal,
          projekt: projectVal,
          projectName: projectVal,
          subProjectName: subVal,
        };

        try {
          await apiFetch(`/time-reports/${r.id}`, {
            method: "PUT",
            body: payload,
          });
        } catch (e) {
          console.warn("API update misslyckades, sparar lokalt:", e);
        }

        reports[realIndex] = {
          ...reports[realIndex],
          ...payload,
          date: dateVal,
          start: roundedStart,
          end: roundedEnd,
          hours: hoursVal,
          userName: nameVal,
        };
        saveReports();
        buildFilterOptions();
        render();
      });

      tbody.appendChild(tr);
    });

    toggleEmptyState(filtered.length > 0);
  }

  filterUser.addEventListener("change", render);
  filterCustomer.addEventListener("change", render);
  filterProject.addEventListener("change", render);
  filterSubproject.addEventListener("change", render);
  filterStatus.addEventListener("change", render);

  clearFiltersBtn.addEventListener("click", () => {
    filterUser.value = "";
    filterProject.value = "";
    filterSubproject.value = "";
    filterStatus.value = "";
    filterCustomer.value = "";
    render();
  });

  function setMobileMode(on) {
    document.body.classList.toggle("mobile-mode", on);
    [mobileViewBtn, mobileViewBtnSidebar].forEach((btn) => btn?.classList.toggle("active", on));
    [tableViewBtn, tableViewBtnSidebar].forEach((btn) => btn?.classList.toggle("active", !on));
    render();
  }

  mobileViewBtn?.addEventListener("click", () => setMobileMode(true));
  tableViewBtn?.addEventListener("click", () => setMobileMode(false));
  mobileViewBtnSidebar?.addEventListener("click", () => setMobileMode(true));
  tableViewBtnSidebar?.addEventListener("click", () => setMobileMode(false));

  // Tooltip / submenu toggle for sidebar items (Adminhub, Projekt, Planering)
  function closeAllTooltips(except = null) {
    document.querySelectorAll('.admin-hub.open').forEach((el) => {
      if (el === except) return;
      el.classList.remove('open');
      const btn = el.querySelector('.nav-section-toggle');
      if (btn) btn.setAttribute('aria-expanded', 'false');
      const menu = el.querySelector('.admin-submenu');
      if (menu) menu.setAttribute('aria-hidden', 'true');
    });
  }

  document.querySelectorAll('.nav-section-toggle').forEach((btn) => {
    btn.addEventListener('click', (e) => {
      e.stopPropagation();
      const parent = btn.parentElement;
      if (!parent) return;
      const isOpen = parent.classList.toggle('open');
      btn.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
      const menu = parent.querySelector('.admin-submenu');
      if (menu) menu.setAttribute('aria-hidden', isOpen ? 'false' : 'true');
      if (isOpen) closeAllTooltips(parent);
    });
  });

  // Submenus are in-flow and will push following items down; no JS positioning required

  // Close tooltips when clicking outside
  document.addEventListener('click', (ev) => {
    closeAllTooltips();
  });

  // Close with Escape
  document.addEventListener('keydown', (ev) => {
    if (ev.key === 'Escape') {
      closeAllTooltips();
    }
  });

  // Mark current page as active in sidebar and submenu
  function highlightCurrentNav() {
    const path = (window.location.pathname || '');
    const currentFile = path.split('/').pop() || '';
    const currentNoQuery = currentFile.split('?')[0].split('#')[0];
    const currentNoExt = currentNoQuery.replace(/\.[^/.]+$/, '');

    document.querySelectorAll('.nav-item').forEach((el) => {
      const href = (el.getAttribute('href') || '').trim();
      const hrefTarget = href.split('/').pop().split('?')[0].split('#')[0];
      const hrefNoExt = hrefTarget.replace(/\.[^/.]+$/, '');

      const matchExact = hrefTarget && currentNoQuery && hrefTarget === currentNoQuery;
      const matchNoExt = hrefNoExt && currentNoExt && hrefNoExt === currentNoExt;
      const matchContained = hrefTarget && currentNoQuery && (hrefTarget === '' ? false : currentNoQuery.indexOf(hrefNoExt) !== -1);
      const matchReverseContained = hrefTarget && currentNoQuery && (hrefNoExt.indexOf(currentNoExt) !== -1);

      const isMatch = matchExact || matchNoExt || matchContained || matchReverseContained;

      if (isMatch) {
        el.classList.add('active');
        const parentHub = el.closest('.admin-hub');
        if (parentHub) {
          parentHub.classList.add('open');
          const btn = parentHub.querySelector('.nav-section-toggle');
          if (btn) btn.setAttribute('aria-expanded', 'true');
          const menu = parentHub.querySelector('.admin-submenu');
          if (menu) menu.setAttribute('aria-hidden', 'false');
        }
      } else {
        el.classList.remove('active');
      }
    });
  }

  // Run once on load to reflect current page (works across admin pages)
  highlightCurrentNav();

  document.getElementById("downloadPdfBtn").addEventListener("click", () => {
    const attested = reports.filter((r) => r.status === "Attesterad");
    const list = attested.length ? attested : reports;

    if (!list.length) {
      alert("Det finns inga tidrapporter att skriva ut.");
      return;
    }

    const totals = {
      hours: 0,
      travel: 0,
      day: 0,
      evening: 0,
      night: 0,
      weekend: 0,
    };
    const materialTotals = {};

    let rowsHtml = "";
    list.forEach((r) => {
      const ob = splitObHours(r);
      const totalHours = calcHours(r);
      const travel = parseFloat(r.restid || "0") || 0;

      const projectName = getProjectName(r);
      const subProjectName = getSubProjectName(r);
      const devs = getDeviationsForReport(r);
      const devCount = devs.length;

      totals.hours += totalHours;
      totals.travel += travel;
      totals.day += ob.dag;
      totals.evening += ob.kv√§ll;
      totals.night += ob.natt;
      totals.weekend += ob.helg;

      (r.materials || []).forEach((m) => {
        const key = m.typeName || m.type || "Material";
        const qty = Number(m.quantity || 0) || 0;
        materialTotals[key] = (materialTotals[key] || 0) + qty;
      });

      rowsHtml += `
        <tr>
          <td>${r.datum || "-"}</td>
          <td>${(r.userName || "").replace(/</g, "&lt;")}</td>
          <td>${projectName.replace(/</g, "&lt;")}</td>
          <td>${(subProjectName || "").replace(/</g, "&lt;")}</td>
          <td>${r.starttid || "-"}</td>
          <td>${r.sluttid || "-"}</td>
          <td>${totalHours.toFixed(1)}</td>
          <td>${ob.dag.toFixed(1)}</td>
          <td>${ob.kv√§ll.toFixed(1)}</td>
          <td>${ob.natt.toFixed(1)}</td>
          <td>${ob.helg.toFixed(1)}</td>
          <td>${travel.toFixed(1)}</td>
          <td>${devCount}</td>
        </tr>
        ${
          (r.comment || "").trim()
            ? `<tr><td colspan="13" style="background:#f9fafb;">Kommentar: ${(r.comment || "")
                .replace(/</g, "&lt;")}</td></tr>`
            : ""
        }
      `;
    });

    const win = window.open("", "_blank");
    if (!win) {
      alert("Popup blockerad ‚Äì till√•t popup f√∂r att skapa PDF.");
      return;
    }

    const html = `
      <html lang="sv">
      <head>
        <meta charset="UTF-8" />
        <title>Tidrapport ‚Äì kundunderlag</title>
        <style>
          body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            font-size: 12px;
            margin: 24px;
          }
          h1 {
            font-size: 20px;
            margin-bottom: 4px;
          }
          p {
            margin: 0 0 12px;
            color: #4b5563;
          }
          table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 8px;
          }
          th, td {
            padding: 6px 8px;
            border: 1px solid #d1d5db;
            text-align: left;
          }
          th {
            background: #f3f4f6;
          }
        </style>
      </head>
      <body>
        <h1>Tidrapport ‚Äì kundunderlag</h1>
        <p>
          Underlag med dag-, kv√§ll-, natt- och helgtimmar per anv√§ndare.
          OB‚Äëprocent visas inte, endast timmar och restid.
        </p>
        <table>
          <thead>
            <tr>
              <th>Datum</th>
              <th>Anv√§ndare</th>
              <th>Projekt</th>
              <th>Underprojekt</th>
              <th>Start</th>
              <th>Slut</th>
              <th>Totalt (h)</th>
              <th>OB dag</th>
              <th>OB kv√§ll</th>
              <th>OB natt</th>
              <th>OB helg</th>
              <th>Restid</th>
              <th>Avvikelser</th>
            </tr>
          </thead>
          <tbody>
            ${rowsHtml}
          </tbody>
        </table>

    <h2>Sammanst√§llning</h2>
    <table>
      <tbody>
        <tr><th>Totalt timmar</th><td>${totals.hours.toFixed(1)} h</td></tr>
        <tr><th>Restid</th><td>${totals.travel.toFixed(1)} h</td></tr>
        <tr><th>Dag</th><td>${totals.day.toFixed(1)} h</td></tr>
        <tr><th>Kv√§ll</th><td>${totals.evening.toFixed(1)} h</td></tr>
        <tr><th>Natt</th><td>${totals.night.toFixed(1)} h</td></tr>
        <tr><th>Helg</th><td>${totals.weekend.toFixed(1)} h</td></tr>
      </tbody>
    </table>

    ${
      Object.keys(materialTotals).length
        ? `<h3>Material</h3>
           <table>
             <thead><tr><th>Typ</th><th>Antal</th></tr></thead>
             <tbody>
               ${Object.entries(materialTotals)
                 .map(
                   ([name, qty]) =>
                     `<tr><td>${name.replace(/</g, "&lt;")}</td><td>${qty}</td></tr>`
                 )
                 .join("")}
             </tbody>
           </table>`
        : ""
    }

    <h2>Avvikelser kopplade till rapporter</h2>
    <p>Avvikelser kopplade via tidrapport eller projekt. Bilder b√§ddas in om de finns.</p>
    <table>
      <thead>
        <tr>
          <th>Datum</th>
          <th>Rubrik</th>
          <th>Projekt</th>
          <th>Tidrapport</th>
          <th>Allvarlighet</th>
          <th>Status</th>
          <th>Bild</th>
        </tr>
      </thead>
      <tbody>
        ${list
          .map((r) => getDeviationsForReport(r))
          .flat()
          .map((d) => {
            const sev =
              d.severity === "critical"
                ? "Kritisk"
                : d.severity === "high"
                ? "H√∂g"
                : d.severity === "medium"
                ? "Medel"
                : "L√•g";
            const stat =
              d.status === "resolved"
                ? "√Ötg√§rdad"
                : d.status === "in_progress"
                ? "P√•g√•r"
                : "√ñppen";
            return `
              <tr>
                <td>${d.date || "-"}</td>
                <td>${(d.title || "").replace(/</g, "&lt;")}</td>
                <td>${(d.projectName || "").replace(/</g, "&lt;")}</td>
                <td>${(d.reportLabel || "").replace(/</g, "&lt;")}</td>
                <td>${sev}</td>
                <td>${stat}</td>
                <td>${d.image ? "<img src='" + d.image + "' style='width:120px; height:auto; border:1px solid #e5e7eb; border-radius:6px;' />" : "-"}</td>
              </tr>
            `;
          })
          .join("")}
      </tbody>
    </table>
      </body>
      </html>
    `;

    win.document.open();
    win.document.write(html);
    win.document.close();
    win.focus();
    win.print();
  });

  // Ladda rapporter fr√•n server och rendera
  loadReportsFromServer();
</script>
</body>
</html>
