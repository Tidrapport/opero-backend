<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <title>Rail Work AB ‚Äì Attestering</title>
  <style>
    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      background: #f3f4f6;
    }

    .sidebar {
      width: 240px;
      background: #0f172a;
      color: #e5e7eb;
      padding: 16px 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .sidebar h2 {
      font-size: 18px;
      margin: 0 0 16px;
    }

    .nav-section-title {
      font-size: 11px;
      text-transform: uppercase;
      opacity: 0.6;
      margin-top: 12px;
    }

    .nav-item {
      padding: 8px 10px;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
      text-decoration: none;
      color: inherit;
      display: block;
    }

    .nav-item.active { background: #1d4ed8; }
    .nav-item:hover { background: #111827; }

    .logout {
      margin-top: auto;
      font-size: 13px;
      color: #f97373;
      cursor: pointer;
    }

    .main { flex: 1; padding: 24px 32px; }

    .topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }

    .topbar h1 { margin: 0; font-size: 22px; }
    .topbar small { color: #6b7280; }
    .welcome { font-size: 14px; color: #374151; }

    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .page-header h2 { margin: 0; font-size: 20px; }
    .page-header p { margin: 4px 0 0; font-size: 13px; color: #6b7280; }

    .btn-secondary {
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      background: #fff;
      cursor: pointer;
      font-size: 13px;
    }

    .btn-secondary:hover { background: #f3f4f6; }

    .card {
      background: #fff;
      border-radius: 12px;
      padding: 16px 18px;
      box-shadow: 0 8px 20px rgba(15, 23, 42, 0.08);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }

    th, td {
      padding: 8px 10px;
      border-bottom: 1px solid #e5e7eb;
      text-align: left;
      vertical-align: top;
    }

    th {
      font-size: 11px;
      text-transform: uppercase;
      color: #6b7280;
    }

    .name-input {
      width: 120px;
      padding: 4px 6px;
      border-radius: 6px;
      border: 1px solid #d1d5db;
      font-size: 12px;
    }

    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
    }

    .status-ny {
      background: #fee2e2;
      color: #b91c1c;
    }

    .status-attesterad {
      background: #dcfce7;
      color: #166534;
    }

    .actions {
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
    }

    .btn-small {
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      background: #fff;
      font-size: 11px;
      cursor: pointer;
    }

    .btn-small.attest {
      border-color: #22c55e;
      color: #15803d;
    }

    .btn-small.delete {
      border-color: #f87171;
      color: #b91c1c;
    }

    .badge-empty {
      font-size: 13px;
      color: #6b7280;
      margin-top: 8px;
    }

    .filters {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 12px;
      font-size: 12px;
    }

    .filters label {
      display: flex;
      flex-direction: column;
      gap: 2px;
      color: #374151;
    }

    .filters select {
      min-width: 150px;
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      font-size: 12px;
      background: #fff;
    }

    .filters button {
      align-self: flex-end;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      background: #fff;
      cursor: pointer;
      font-size: 12px;
    }

    .filters button:hover {
      background: #f3f4f6;
    }
  </style>
</head>
<body>
<!-- SIDEBAR -->
<aside class="sidebar">
  <h2>Admina Bas</h2>

  <div class="nav-section">
    <a href="dashboard.html" class="nav-item">√ñversikt</a>
    <a href="tidrapporter.html" class="nav-item">Tidrapporter</a>
    <a href="planning.html" class="nav-item">Planering</a>
    <a href="deviations.html" class="nav-item">Avvikelser</a>
    <a href="salary-overview.html" class="nav-item">L√∂n√∂versikt</a>
    <a href="contacts.html" class="nav-item">Kontakter</a>
  </div>

  <div class="nav-section-title admin-only">Administration</div>
  <a href="admin.html" class="nav-item admin-only active">Attestering</a>
  <a href="projects.html" class="nav-item admin-only">Projekt</a>
  <a href="job_roles.html" class="nav-item admin-only">Yrkesroller</a>
  <a href="material_types.html" class="nav-item admin-only">Materialtyper</a>
  <a href="ob_settings.html" class="nav-item admin-only">OB-inst√§llningar</a>
  <a href="admin-users.html" class="nav-item admin-only">Anv√§ndare</a>

  <div class="logout" id="logoutBtn">‚¨Ö Logga ut</div>
</aside>

<!-- MAIN -->
<main class="main">
  <div class="topbar">
    <div>
      <h1>Rail Work AB</h1>
      <small>Attestering av tidrapporter</small>
    </div>
    <div class="welcome" id="welcomeText">V√§lkommen</div>
  </div>

  <div class="page-header">
    <div>
      <h2>Attestering av tidrapporter</h2>
      <p>
        V√§lj projekt, underprojekt och anv√§ndare f√∂r att attestera r√§tt rader.
        N√§r en rad √§r attesterad l√•ses den f√∂r anv√§ndaren.
      </p>
    </div>
    <button class="btn-secondary" id="downloadPdfBtn">Exportera PDF (attesterade)</button>
  </div>

  <div class="card">
    <!-- FILTERS -->
    <div class="filters">
      <label>
        Anv√§ndare
        <select id="filterUser">
          <option value="">Alla anv√§ndare</option>
        </select>
      </label>

      <label>
        Projekt
        <select id="filterProject">
          <option value="">Alla projekt</option>
        </select>
      </label>

      <label>
        Underprojekt
        <select id="filterSubproject">
          <option value="">Alla underprojekt</option>
        </select>
      </label>

      <label>
        Status
        <select id="filterStatus">
          <option value="">Alla</option>
          <option value="Ny">Ny</option>
          <option value="Attesterad">Attesterad</option>
        </select>
      </label>

      <button id="clearFiltersBtn">Rensa filter</button>
    </div>

    <table>
      <thead>
        <tr>
          <th>Datum</th>
          <th>Anv√§ndare</th>
          <th>Projekt</th>
          <th>Underprojekt</th>
          <th>Start</th>
          <th>Slut</th>
          <th>Totalt (h)</th>
          <th>Dag</th>
          <th>Kv√§ll</th>
          <th>Natt</th>
          <th>Helg</th>
          <th>Restid (h)</th>
          <th>Status</th>
          <th>√Ötg√§rder</th>
        </tr>
      </thead>
      <tbody id="reportsBody"></tbody>
    </table>
    <div id="emptyState" class="badge-empty">
      Inga tidrapporter hittades. Be anv√§ndarna rapportera tid p√• sidan <strong>Tidrapporter</strong>.
    </div>
  </div>
</main>

<script src="auth.js"></script>
<script>
  (function syncUser() {
    const raw = localStorage.getItem("user");
    if (raw && !localStorage.getItem("currentUser")) {
      try {
        const u = JSON.parse(raw);
        const mapped = {
          ...u,
          firstName: u.firstName || u.first_name || "",
          lastName: u.lastName || u.last_name || ""
        };
        setCurrentUser(mapped);
      } catch (e) {}
    }
  })();

  const currentUser = requireLogin();
  setupSidebarForUser(currentUser);

  if (!isAdmin(currentUser)) {
    alert("Endast admin har √•tkomst till denna sida.");
    window.location.href = "dashboard.html";
  }

  document.getElementById("logoutBtn").addEventListener("click", () => {
    localStorage.removeItem("token");
    localStorage.removeItem("currentUser");
    localStorage.removeItem("user");
    window.location.href = "login.html";
  });

  const STORAGE_KEY = "timeReports";
  const PROJECTS_KEY = "projects";
  const SUBPROJECTS_KEY = "subProjects";

  let reports = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
  let projects = JSON.parse(localStorage.getItem(PROJECTS_KEY) || "[]");
  let subProjects = JSON.parse(localStorage.getItem(SUBPROJECTS_KEY) || "[]");

  // Defaults
  reports.forEach((r) => {
    if (!r.status) r.status = "Ny";
    if (!r.userName) r.userName = "";
    if (r.restid === undefined) r.restid = 0;
    if (r.rast === undefined) r.rast = 0;
  });
  saveReports();

  function saveReports() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(reports));
  }

  function parseDate(dateStr) {
    const [y, m, d] = (dateStr || "").split("-").map(Number);
    if (!y || !m || !d) return new Date();
    return new Date(y, m - 1, d);
  }

  function calcHours(report) {
    const fallback = parseFloat(report.timmar || report.hours || "0");
    if (!Number.isNaN(fallback) && fallback > 0) {
      return fallback;
    }

    const dateStr = report.datum || report.date;
    const startStr = report.starttid || report.start;
    const endStr = report.sluttid || report.end;
    if (!dateStr || !startStr || !endStr) return 0;

    const [sh, sm] = startStr.split(":").map(Number);
    const [eh, em] = endStr.split(":").map(Number);

    const startDate = new Date(dateStr);
    startDate.setHours(sh || 0, sm || 0, 0, 0);

    const endDate = new Date(dateStr);
    endDate.setHours(eh || 0, em || 0, 0, 0);

    if (endDate <= startDate) {
      endDate.setDate(endDate.getDate() + 1);
    }

    const diffMinutes = (endDate - startDate) / 60000;
    const roundedMinutes = Math.round(diffMinutes / 10) * 10; // 10-minuterssteg
    const roundedHours = roundedMinutes / 60;

    return roundedHours > 0 ? parseFloat(roundedHours.toFixed(2)) : 0;
  }

  function getObCategory(dateObj) {
    const dow = dateObj.getDay();
    const hour = dateObj.getHours();

    // Helg: fre 18:00 -> m√•n 06:00
    if (
      (dow === 5 && hour >= 18) ||
      dow === 6 ||
      dow === 0 ||
      (dow === 1 && hour < 6)
    ) {
      return "helg";
    }
    if (hour >= 21 || hour < 6) return "natt";
    if (hour >= 18 && hour < 21) return "kv√§ll";
    return "dag";
  }

  function splitObHours(report) {
    const result = { dag: 0, kv√§ll: 0, natt: 0, helg: 0 };
    if (!report.datum || !report.starttid || !report.sluttid) return result;

    const [sh, sm] = report.starttid.split(":").map(Number);
    const [eh, em] = report.sluttid.split(":").map(Number);

    let startDate = parseDate(report.datum);
    startDate.setHours(sh || 0, sm || 0, 0, 0);

    let endDate = parseDate(report.datum);
    endDate.setHours(eh || 0, em || 0, 0, 0);

    if (endDate <= startDate) {
      endDate.setDate(endDate.getDate() + 1);
    }

    const stepMinutes = 15;
    let cursor = new Date(startDate);

    while (cursor < endDate) {
      const cat = getObCategory(cursor);
      result[cat] += stepMinutes / 60;
      cursor = new Date(cursor.getTime() + stepMinutes * 60000);
    }

    return result;
  }

  function toggleEmptyState(hasRows) {
    document.getElementById("emptyState").style.display =
      hasRows ? "none" : "block";
  }

  const tbody = document.getElementById("reportsBody");
  const filterUser = document.getElementById("filterUser");
  const filterProject = document.getElementById("filterProject");
  const filterSubproject = document.getElementById("filterSubproject");
  const filterStatus = document.getElementById("filterStatus");
  const clearFiltersBtn = document.getElementById("clearFiltersBtn");

  function buildFilterOptions() {
    // Anv√§ndare
    const userSet = new Set();
    reports.forEach((r) => {
      if (r.userName && r.userName.trim() !== "") {
        userSet.add(r.userName.trim());
      }
    });
    filterUser.innerHTML = '<option value="">Alla anv√§ndare</option>';
    [...userSet].sort().forEach((name) => {
      const opt = document.createElement("option");
      opt.value = name;
      opt.textContent = name;
      filterUser.appendChild(opt);
    });

    // Projekt
    projects = JSON.parse(localStorage.getItem(PROJECTS_KEY) || "[]");
    subProjects = JSON.parse(localStorage.getItem(SUBPROJECTS_KEY) || "[]");

    const currentProjValue = filterProject.value;
    const currentSubValue = filterSubproject.value;

    filterProject.innerHTML = '<option value="">Alla projekt</option>';
    projects.forEach((p) => {
      const opt = document.createElement("option");
      opt.value = p.id;
      opt.textContent = p.name;
      filterProject.appendChild(opt);
    });
    if (currentProjValue) filterProject.value = currentProjValue;

    // Underprojekt
    filterSubproject.innerHTML =
      '<option value="">Alla underprojekt</option>';
    subProjects.forEach((sp) => {
      const opt = document.createElement("option");
      opt.value = sp.id;
      opt.textContent = sp.name;
      filterSubproject.appendChild(opt);
    });
    if (currentSubValue) filterSubproject.value = currentSubValue;
  }

  function getProjectName(r) {
    return (
      r.projectName ||
      (r.projectId && (projects.find((p) => p.id === r.projectId) || {}).name) ||
      r.projekt ||
      "-"
    );
  }

  function getSubProjectName(r) {
    return (
      r.subProjectName ||
      (r.subProjectId &&
        (subProjects.find((sp) => sp.id === r.subProjectId) || {}).name) ||
      ""
    );
  }

  function getFilteredReports() {
    const userVal = filterUser.value;
    const projVal = filterProject.value;
    const subVal = filterSubproject.value;
    const statusVal = filterStatus.value;

    return reports.filter((r) => {
      const matchesUser =
        !userVal || (r.userName || "").trim() === userVal;
      const matchesProject = !projVal || r.projectId === projVal;
      const matchesSub = !subVal || r.subProjectId === subVal;
      const matchesStatus = !statusVal || r.status === statusVal;

      return matchesUser && matchesProject && matchesSub && matchesStatus;
    });
  }

  function render() {
    tbody.innerHTML = "";

    const filtered = getFilteredReports();

    filtered.forEach((r) => {
      const realIndex = reports.indexOf(r);

      const ob = splitObHours(r);
      const tr = document.createElement("tr");

      const totalHours = calcHours(r);
      const travel = parseFloat(r.restid || "0") || 0;

      const projectName = getProjectName(r);
      const subProjectName = getSubProjectName(r);

      tr.innerHTML = `
        <td>${r.datum || "-"}</td>
        <td>
          <input class="name-input" type="text" value="${r.userName || ""}" />
        </td>
        <td>${projectName}</td>
        <td>${subProjectName || "-"}</td>
        <td>${r.starttid || "-"}</td>
        <td>${r.sluttid || "-"}</td>
        <td>${totalHours.toFixed(1)}</td>
        <td>${ob.dag.toFixed(1)}</td>
        <td>${ob.kv√§ll.toFixed(1)}</td>
        <td>${ob.natt.toFixed(1)}</td>
        <td>${ob.helg.toFixed(1)}</td>
        <td>${travel.toFixed(1)}</td>
        <td>
          <span class="status-badge ${
            r.status === "Attesterad" ? "status-attesterad" : "status-ny"
          }">
            ${r.status === "Attesterad" ? "üîí Attesterad" : "Ny"}
          </span>
        </td>
        <td>
          <div class="actions">
            <button class="btn-small attest">
              ${r.status === "Attesterad" ? "Ta bort attest" : "Attestera"}
            </button>
            <button class="btn-small delete">Ta bort</button>
          </div>
        </td>
      `;

      const nameInput = tr.querySelector(".name-input");
      nameInput.addEventListener("change", () => {
        reports[realIndex].userName = nameInput.value.trim();
        saveReports();
        buildFilterOptions();
      });

      const attestBtn = tr.querySelector(".btn-small.attest");
      attestBtn.addEventListener("click", () => {
        if (reports[realIndex].status === "Attesterad") {
          reports[realIndex].status = "Ny";
        } else {
          reports[realIndex].status = "Attesterad";
        }
        saveReports();
        render();
      });

      const deleteBtn = tr.querySelector(".btn-small.delete");
      deleteBtn.addEventListener("click", () => {
        if (!confirm("Vill du ta bort den h√§r tidrapporten?")) return;
        reports.splice(realIndex, 1);
        saveReports();
        buildFilterOptions();
        render();
      });

      tbody.appendChild(tr);
    });

    toggleEmptyState(filtered.length > 0);
  }

  filterUser.addEventListener("change", render);
  filterProject.addEventListener("change", render);
  filterSubproject.addEventListener("change", render);
  filterStatus.addEventListener("change", render);

  clearFiltersBtn.addEventListener("click", () => {
    filterUser.value = "";
    filterProject.value = "";
    filterSubproject.value = "";
    filterStatus.value = "";
    render();
  });

  document.getElementById("downloadPdfBtn").addEventListener("click", () => {
    const attested = reports.filter((r) => r.status === "Attesterad");
    const list = attested.length ? attested : reports;

    if (!list.length) {
      alert("Det finns inga tidrapporter att skriva ut.");
      return;
    }

    let rowsHtml = "";
    list.forEach((r) => {
      const ob = splitObHours(r);
      const totalHours = calcHours(r);
      const travel = parseFloat(r.restid || "0") || 0;

      const projectName = getProjectName(r);
      const subProjectName = getSubProjectName(r);

      rowsHtml += `
        <tr>
          <td>${r.datum || "-"}</td>
          <td>${(r.userName || "").replace(/</g, "&lt;")}</td>
          <td>${projectName.replace(/</g, "&lt;")}</td>
          <td>${(subProjectName || "").replace(/</g, "&lt;")}</td>
          <td>${r.starttid || "-"}</td>
          <td>${r.sluttid || "-"}</td>
          <td>${totalHours.toFixed(1)}</td>
          <td>${ob.dag.toFixed(1)}</td>
          <td>${ob.kv√§ll.toFixed(1)}</td>
          <td>${ob.natt.toFixed(1)}</td>
          <td>${ob.helg.toFixed(1)}</td>
          <td>${travel.toFixed(1)}</td>
        </tr>
      `;
    });

    const win = window.open("", "_blank");
    if (!win) {
      alert("Popup blockerad ‚Äì till√•t popup f√∂r att skapa PDF.");
      return;
    }

    const html = `
      <html lang="sv">
      <head>
        <meta charset="UTF-8" />
        <title>Tidrapport ‚Äì kundunderlag</title>
        <style>
          body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            font-size: 12px;
            margin: 24px;
          }
          h1 {
            font-size: 20px;
            margin-bottom: 4px;
          }
          p {
            margin: 0 0 12px;
            color: #4b5563;
          }
          table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 8px;
          }
          th, td {
            padding: 6px 8px;
            border: 1px solid #d1d5db;
            text-align: left;
          }
          th {
            background: #f3f4f6;
          }
        </style>
      </head>
      <body>
        <h1>Tidrapport ‚Äì kundunderlag</h1>
        <p>
          Underlag med dag-, kv√§ll-, natt- och helgtimmar per anv√§ndare.
          OB‚Äëprocent visas inte, endast timmar och restid.
        </p>
        <table>
          <thead>
            <tr>
              <th>Datum</th>
              <th>Anv√§ndare</th>
              <th>Projekt</th>
              <th>Underprojekt</th>
              <th>Start</th>
              <th>Slut</th>
              <th>Totalt (h)</th>
              <th>Dag</th>
              <th>Kv√§ll</th>
              <th>Natt</th>
              <th>Helg</th>
              <th>Restid (h)</th>
            </tr>
          </thead>
          <tbody>
            ${rowsHtml}
          </tbody>
        </table>
      </body>
      </html>
    `;

    win.document.open();
    win.document.write(html);
    win.document.close();
    win.focus();
    win.print();
  });

  buildFilterOptions();
  render();
</script>
</body>
</html>
