<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <title>Rail Work AB – Tidrapporter</title>
  <style>
    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      background: #f3f4f6;
    }

    /* SIDEBAR */

    .sidebar {
      width: 240px;
      background: #0f172a;
      color: #e5e7eb;
      padding: 16px 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .sidebar h2 {
      font-size: 18px;
      margin: 0 0 16px;
    }

    .nav-section-title {
      font-size: 11px;
      text-transform: uppercase;
      opacity: 0.6;
      margin-top: 12px;
    }

    .nav-item {
      padding: 8px 10px;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
      text-decoration: none;
      color: inherit;
      display: block;
    }

    .nav-item.active {
      background: #1d4ed8;
    }

    .nav-item:hover {
      background: #111827;
    }

    .logout {
      margin-top: auto;
      font-size: 13px;
      color: #f97373;
      cursor: pointer;
    }

    /* MAIN */

    .main {
      flex: 1;
      padding: 24px 32px;
    }

    .topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }

    .topbar h1 {
      margin: 0;
      font-size: 22px;
    }

    .topbar small {
      color: #6b7280;
    }

    .welcome {
      font-size: 14px;
      color: #374151;
    }

    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .page-header h2 {
      margin: 0;
      font-size: 20px;
    }

    .page-header p {
      margin: 4px 0 0;
      font-size: 13px;
      color: #6b7280;
    }

    .btn-primary {
      padding: 8px 16px;
      border-radius: 999px;
      border: none;
      background: #1d4ed8;
      color: #fff;
      font-weight: 500;
      font-size: 14px;
      cursor: pointer;
    }

    .btn-primary:hover {
      background: #1e40af;
    }

    .card {
      background: #fff;
      border-radius: 12px;
      padding: 16px 18px;
      box-shadow: 0 8px 20px rgba(15, 23, 42, 0.08);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    th, td {
      padding: 8px 10px;
      border-bottom: 1px solid #e5e7eb;
      text-align: left;
      vertical-align: top;
    }

    th {
      font-size: 12px;
      text-transform: uppercase;
      color: #6b7280;
    }

    /* MODAL */

    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.55);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }

    .modal {
      width: 100%;
      max-width: 780px;
      background: #ffffff;
      border-radius: 18px;
      padding: 24px 24px 20px;
      box-shadow: 0 24px 50px rgba(15, 23, 42, 0.35);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .modal-header h3 {
      margin: 0;
      font-size: 18px;
    }

    .modal-close {
      border: none;
      background: transparent;
      font-size: 20px;
      cursor: pointer;
      color: #6b7280;
    }

    .modal-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 12px 16px;
      margin-bottom: 12px;
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 13px;
    }

    .field label {
      color: #374151;
    }

    .field input,
    .field select,
    .field textarea {
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      font-size: 13px;
      resize: vertical;
    }

    .field textarea {
      min-height: 70px;
    }

    .field input:focus,
    .field select:focus,
    .field textarea:focus {
      outline: none;
      border-color: #2563eb;
      box-shadow: 0 0 0 1px #2563eb25;
    }

    .modal-footer {
      margin-top: 16px;
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }

    .btn-secondary {
      padding: 8px 16px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      background: #fff;
      cursor: pointer;
      font-size: 14px;
    }

    .badge-empty {
      font-size: 13px;
      color: #6b7280;
      margin-top: 8px;
    }

    /* Action-knappar i tabellen */

    .actions {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .btn-small {
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      background: #fff;
      font-size: 11px;
      cursor: pointer;
    }

    .btn-small.edit {
      border-color: #3b82f6;
      color: #1d4ed8;
    }

    .btn-small.delete {
      border-color: #f87171;
      color: #b91c1c;
    }
  </style>
</head>
<body>
  <aside class="sidebar">
    <h2>Admina Bas</h2>

    <a href="dashboard.html" class="nav-item">Översikt</a>
    <a href="tidrapporter.html" class="nav-item active">Tidrapporter</a>
    <div class="nav-item">Planering</div>
    <div class="nav-item">Avvikelser</div>
    <div class="nav-item">Lönöversikt</div>
    <div class="nav-item">Kontakter</div>

    <div class="nav-section-title">Administration</div>
    <div class="nav-item">Admin Panel</div>
    <div class="nav-item">Användare</div>
    <div class="nav-item">Projekt</div>

    <div class="logout" id="logoutBtn">⬅ Logga ut</div>
  </aside>

  <main class="main">
    <div class="topbar">
      <div>
        <h1>Rail Work AB</h1>
        <small>Tidrapporter – registrera och hantera dina arbetstimmar</small>
      </div>
      <div class="welcome">Välkommen, EdgarLukas</div>
    </div>

    <div class="page-header">
      <div>
        <h2>Tidrapporter</h2>
        <p>Här registrerar användarna sina arbetspass. Alla tidrapporter visas nedan.</p>
      </div>
      <button class="btn-primary" id="newReportBtn">+ Ny tidrapport</button>
    </div>

    <div class="card">
      <table id="reportsTable">
        <thead>
          <tr>
            <th>Datum</th>
            <th>Start</th>
            <th>Slut</th>
            <th>Projekt</th>
            <th>Roll</th>
            <th>Beskrivning</th>
            <th>Tim</th>
            <th>Åtgärder</th>
          </tr>
        </thead>
        <tbody id="reportsBody">
          <!-- rader renderas via JS -->
        </tbody>
      </table>
      <div id="emptyState" class="badge-empty">
        Inga tidrapporter ännu. Klicka på <strong>“Ny tidrapport”</strong> för att lägga till den första.
      </div>
    </div>
  </main>

  <!-- MODAL -->

  <div class="modal-backdrop" id="modalBackdrop">
    <div class="modal">
      <div class="modal-header">
        <h3 id="modalTitle">Ny tidrapport</h3>
        <button class="modal-close" id="closeModalBtn">&times;</button>
      </div>

      <form id="reportForm">
        <div class="modal-grid">
          <div class="field">
            <label for="datum">Datum</label>
            <input type="date" id="datum" required />
          </div>

          <div class="field">
            <label for="rast">Rast</label>
            <select id="rast">
              <option>Ingen rast</option>
              <option>30 min</option>
              <option>60 min</option>
            </select>
          </div>

          <div class="field">
            <label for="starttid">Starttid</label>
            <input type="time" id="starttid" required />
          </div>

          <div class="field">
            <label for="sluttid">Sluttid</label>
            <input type="time" id="sluttid" required />
          </div>

          <div class="field">
            <label for="projekt">Projekt</label>
            <select id="projekt" required>
              <option value="">Välj projekt</option>
              <option>Projekt A</option>
              <option>Projekt B</option>
              <option>Projekt C</option>
            </select>
          </div>

          <div class="field">
            <label for="roll">Yrkesroll</label>
            <select id="roll" required>
              <option value="">Välj roll</option>
              <option>Montör</option>
              <option>Elektriker</option>
              <option>Arbetsledare</option>
            </select>
          </div>

          <div class="field" style="grid-column: 1 / span 2;">
            <label for="beskrivning">Arbetsbeskrivning</label>
            <textarea id="beskrivning" placeholder="Beskriv vad som utfördes..." required></textarea>
          </div>

          <div class="field">
            <label for="traktamente">Traktamente</label>
            <select id="traktamente">
              <option>Ingen</option>
              <option>Halv dag</option>
              <option>Hel dag</option>
            </select>
          </div>

          <div class="field">
            <label for="restid">Reseersättning (timmar)</label>
            <input type="number" id="restid" min="0" step="0.5" value="0" />
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn-secondary" id="cancelBtn">Avbryt</button>
          <button type="submit" class="btn-primary" id="saveReportBtn">Spara tidrapport</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // enkel "auth" check
    const token = localStorage.getItem("token");
    if (!token) {
      window.location.href = "login.html";
    }

    const logoutBtn = document.getElementById("logoutBtn");
    logoutBtn.addEventListener("click", () => {
      localStorage.removeItem("token");
      window.location.href = "login.html";
    });

    const modalBackdrop = document.getElementById("modalBackdrop");
    const newReportBtn = document.getElementById("newReportBtn");
    const closeModalBtn = document.getElementById("closeModalBtn");
    const cancelBtn = document.getElementById("cancelBtn");
    const reportForm = document.getElementById("reportForm");
    const reportsBody = document.getElementById("reportsBody");
    const emptyState = document.getElementById("emptyState");
    const modalTitle = document.getElementById("modalTitle");

    // Håller alla rapporter i minnet + vilket index vi ev. redigerar
    let reports = JSON.parse(localStorage.getItem("timeReports") || "[]");
    let editingIndex = null; // null = ny rapport, annars index i arrayen

    function openModal(isEdit = false) {
      modalBackdrop.style.display = "flex";
      if (isEdit) {
        modalTitle.textContent = "Redigera tidrapport";
      } else {
        modalTitle.textContent = "Ny tidrapport";
        const today = new Date().toISOString().slice(0, 10);
        document.getElementById("datum").value = today;
      }
    }

    function closeModal() {
      modalBackdrop.style.display = "none";
      reportForm.reset();
      editingIndex = null;
      modalTitle.textContent = "Ny tidrapport";
    }

    newReportBtn.addEventListener("click", () => {
      openModal(false);
    });
    closeModalBtn.addEventListener("click", closeModal);
    cancelBtn.addEventListener("click", closeModal);

    modalBackdrop.addEventListener("click", (e) => {
      if (e.target === modalBackdrop) {
        closeModal();
      }
    });

    function calculateHours(start, end) {
      if (!start || !end) return 0;
      const [sh, sm] = start.split(":").map(Number);
      const [eh, em] = end.split(":").map(Number);
      const startMin = sh * 60 + sm;
      const endMin = eh * 60 + em;
      if (endMin <= startMin) return 0;
      const diff = endMin - startMin;
      return (diff / 60).toFixed(1);
    }

    function toggleEmptyState() {
      emptyState.style.display = reports.length ? "none" : "block";
    }

    function saveReportsToStorage() {
      localStorage.setItem("timeReports", JSON.stringify(reports));
    }

    function renderReports() {
      reportsBody.innerHTML = "";
      reports.forEach((report, index) => {
        const tr = document.createElement("tr");
        tr.dataset.index = index.toString();
        tr.innerHTML = `
          <td>${report.datum}</td>
          <td>${report.starttid}</td>
          <td>${report.sluttid}</td>
          <td>${report.projekt}</td>
          <td>${report.roll}</td>
          <td>${report.beskrivning}</td>
          <td>${report.timmar}</td>
          <td>
            <div class="actions">
              <button type="button" class="btn-small edit">Redigera</button>
              <button type="button" class="btn-small delete">Ta bort</button>
            </div>
          </td>
        `;
        const editBtn = tr.querySelector(".btn-small.edit");
        const deleteBtn = tr.querySelector(".btn-small.delete");

        editBtn.addEventListener("click", () => {
          editingIndex = index;
          const r = reports[index];
          document.getElementById("datum").value = r.datum;
          document.getElementById("rast").value = r.rast || "Ingen rast";
          document.getElementById("starttid").value = r.starttid;
          document.getElementById("sluttid").value = r.sluttid;
          document.getElementById("projekt").value = r.projekt === "-" ? "" : r.projekt;
          document.getElementById("roll").value = r.roll === "-" ? "" : r.roll;
          document.getElementById("beskrivning").value = r.beskrivning;
          document.getElementById("traktamente").value = r.traktamente || "Ingen";
          document.getElementById("restid").value = r.restid || "0";
          openModal(true);
        });

        deleteBtn.addEventListener("click", () => {
          if (confirm("Vill du ta bort den här tidrapporten?")) {
            reports.splice(index, 1);
            saveReportsToStorage();
            renderReports();
            toggleEmptyState();
          }
        });

        reportsBody.appendChild(tr);
      });

      toggleEmptyState();
    }

    // Ladda initialt
    renderReports();

    reportForm.addEventListener("submit", (e) => {
      e.preventDefault();

      const report = {
        datum: document.getElementById("datum").value,
        rast: document.getElementById("rast").value,
        starttid: document.getElementById("starttid").value,
        sluttid: document.getElementById("sluttid").value,
        projekt: document.getElementById("projekt").value || "-",
        roll: document.getElementById("roll").value || "-",
        beskrivning: document.getElementById("beskrivning").value,
        traktamente: document.getElementById("traktamente").value,
        restid: document.getElementById("restid").value || "0",
      };

      report.timmar = calculateHours(report.starttid, report.sluttid);

      if (editingIndex !== null) {
        // uppdatera befintlig
        reports[editingIndex] = report;
      } else {
        // ny rapport
        reports.push(report);
      }

      saveReportsToStorage();
      renderReports();
      closeModal();
    });
  </script>
</body>
</html>
