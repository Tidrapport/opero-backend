<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <title>Rail Work AB ‚Äì Tidrapporter</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      background: #f3f4f6;
    }

    .sidebar {
      width: 240px;
      background: #0f172a;
      color: #e5e7eb;
      padding: 16px 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .sidebar h2 { font-size: 18px; margin: 0 0 16px; }

    .nav-section-title {
      font-size: 11px;
      text-transform: uppercase;
      opacity: 0.6;
      margin-top: 12px;
    }

    .nav-item {
      padding: 8px 10px;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
      text-decoration: none;
      color: inherit;
      display: block;
    }

    .nav-item.active { background: #1d4ed8; }
    .nav-item:hover { background: #111827; }

    .logout {
      margin-top: auto;
      font-size: 13px;
      color: #f97373;
      cursor: pointer;
    }

    .main { flex: 1; padding: 24px 32px; }

    .topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }

    .topbar h1 { margin: 0; font-size: 22px; }
    .topbar small { color: #6b7280; }
    .welcome { font-size: 14px; color: #374151; }

    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .page-header h2 { margin: 0; font-size: 20px; }
    .page-header p { margin: 4px 0 0; font-size: 13px; color: #6b7280; }

    .btn-primary {
      padding: 8px 16px;
      border-radius: 999px;
      border: none;
      background: #1d4ed8;
      color: #fff;
      font-weight: 500;
      font-size: 14px;
      cursor: pointer;
    }
    .btn-primary:hover { background: #1e40af; }

    .card {
      background: #fff;
      border-radius: 12px;
      padding: 16px 18px;
      box-shadow: 0 8px 20px rgba(15,23,42,0.08);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    th, td {
      padding: 8px 10px;
      border-bottom: 1px solid #e5e7eb;
      text-align: left;
      vertical-align: top;
    }

    th {
      font-size: 12px;
      text-transform: uppercase;
      color: #6b7280;
    }

    .badge-empty {
      font-size: 13px;
      color: #6b7280;
      margin-top: 8px;
    }

    .actions {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      align-items: center;
    }

    .btn-small {
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      background: #fff;
      font-size: 11px;
      cursor: pointer;
    }

    .btn-small.edit {
      border-color: #3b82f6;
      color: #1d4ed8;
    }

    .btn-small.delete {
      border-color: #f87171;
      color: #b91c1c;
    }

    .lock-label {
      font-size: 12px;
      color: #16a34a;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    /* MODAL */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.55);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }

    .modal {
      width: 100%;
      max-width: 780px;
      background: #ffffff;
      border-radius: 18px;
      padding: 24px 24px 20px;
      box-shadow: 0 24px 50px rgba(15,23,42,0.35);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .modal-header h3 { margin: 0; font-size: 18px; }

    .modal-close {
      border: none;
      background: transparent;
      font-size: 20px;
      cursor: pointer;
      color: #6b7280;
    }

    .modal-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 12px 16px;
      margin-bottom: 12px;
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 13px;
    }

    .field label { color: #374151; }

    .field input,
    .field select,
    .field textarea {
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      font-size: 13px;
      resize: vertical;
    }

    .field textarea { min-height: 70px; }

    .field input:focus,
    .field select:focus,
    .field textarea:focus {
      outline: none;
      border-color: #2563eb;
      box-shadow: 0 0 0 1px #2563eb25;
    }

    .modal-footer {
      margin-top: 16px;
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }

    .btn-secondary {
      padding: 8px 16px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      background: #fff;
      cursor: pointer;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <!-- SIDEBAR -->
  <aside class="sidebar">
    <h2 id="sidebarCompanyName">Admina Bas</h2>

    <div class="nav-section">
      <a href="dashboard.html" class="nav-item">√ñversikt</a>
      <a href="tidrapporter.html" class="nav-item active">Tidrapporter</a>
      <a href="#" class="nav-item">Planering</a>
      <a href="#" class="nav-item">Avvikelser</a>
      <a href="#" class="nav-item">L√∂n√∂versikt</a>
      <a href="#" class="nav-item">Kontakter</a>
    </div>

    <div class="nav-section-title">Administration</div>
    <a href="admin.html" class="nav-item">Attestering</a>
    <a href="projects.html" class="nav-item">Projekt</a>

    <div class="logout" id="logoutBtn">‚¨Ö Logga ut</div>
  </aside>

  <!-- MAIN -->
  <main class="main">
    <div class="topbar">
      <div>
        <h1 id="companyTitle">Rail Work AB</h1>
        <small>Tidrapporter ‚Äì registrera och hantera dina arbetstimmar</small>
      </div>
      <div class="welcome" id="welcomeText">V√§lkommen</div>
    </div>

    <div class="page-header">
      <div>
        <h2>Tidrapporter</h2>
        <p>H√§r registrerar du dina arbetspass. V√§lj projekt och underprojekt som lagts upp av admin.</p>
      </div>
      <button class="btn-primary" id="newReportBtn">+ Ny tidrapport</button>
    </div>

    <div class="card">
      <table>
        <thead>
          <tr>
            <th>Datum</th>
            <th>Projekt</th>
            <th>Underprojekt</th>
            <th>Start</th>
            <th>Slut</th>
            <th>Roll</th>
            <th>Beskrivning</th>
            <th>Rast (min)</th>
            <th>Restid (h)</th>
            <th>Timmar</th>
            <th>√Ötg√§rder</th>
          </tr>
        </thead>
        <tbody id="reportsBody"></tbody>
      </table>
      <div id="emptyState" class="badge-empty">
        Inga tidrapporter √§nnu. Klicka p√• <strong>‚ÄúNy tidrapport‚Äù</strong> f√∂r att l√§gga till den f√∂rsta.
      </div>
    </div>
  </main>

  <!-- MODAL -->
  <div class="modal-backdrop" id="modalBackdrop">
    <div class="modal">
      <div class="modal-header">
        <h3 id="modalTitle">Ny tidrapport</h3>
        <button class="modal-close" id="closeModalBtn">&times;</button>
      </div>

      <form id="reportForm">
        <div class="modal-grid">
          <div class="field">
            <label for="datum">Datum</label>
            <input type="date" id="datum" required />
          </div>

          <div class="field">
            <label for="rast">Rast (minuter)</label>
            <input type="number" id="rast" min="0" step="5" value="0" />
          </div>

          <div class="field">
            <label for="starttid">Starttid</label>
            <input type="time" id="starttid" required />
          </div>

          <div class="field">
            <label for="sluttid">Sluttid</label>
            <input type="time" id="sluttid" required />
          </div>

          <div class="field">
            <label for="projektSelect">Projekt</label>
            <select id="projektSelect"></select>
          </div>

          <div class="field">
            <label for="subprojektSelect">Underprojekt</label>
            <select id="subprojektSelect"></select>
          </div>

          <div class="field">
            <label for="roll">Yrkesroll</label>
            <input type="text" id="roll" placeholder="Roll..." />
          </div>

          <div class="field" style="grid-column: 1 / span 2;">
            <label for="beskrivning">Arbetsbeskrivning</label>
            <textarea id="beskrivning" placeholder="Beskriv vad som utf√∂rdes..." required></textarea>
          </div>

          <div class="field">
            <label for="traktamente">Traktamente</label>
            <select id="traktamente">
              <option>Ingen</option>
              <option>Halv dag</option>
              <option>Hel dag</option>
            </select>
          </div>

          <div class="field">
            <label for="restid">Reseers√§ttning (timmar)</label>
            <input type="number" id="restid" min="0" step="0.5" value="0" />
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn-secondary" id="cancelBtn">Avbryt</button>
          <button type="submit" class="btn-primary" id="saveReportBtn">Spara tidrapport</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    const STORAGE_KEY = "timeReports";
    const PROJECTS_KEY = "projects";
    const SUBPROJECTS_KEY = "subProjects";

    // üîê Auth
    const token = localStorage.getItem("token");
    const companyId = localStorage.getItem("company_id");
    const companyName = localStorage.getItem("company_name") || "Rail Work AB";
    const userName = localStorage.getItem("user_name") || "anv√§ndare";

    if (!companyId) {
      window.location.href = "company-select.html";
    } else if (!token) {
      window.location.href = "login.html";
    }

    document.getElementById("companyTitle").textContent = companyName;
    document.getElementById("sidebarCompanyName").textContent = companyName;
    document.getElementById("welcomeText").textContent = "V√§lkommen, " + userName;

    document.getElementById("logoutBtn").addEventListener("click", () => {
      localStorage.removeItem("token");
      localStorage.removeItem("user_id");
      localStorage.removeItem("user_name");
      localStorage.removeItem("user_role");
      window.location.href = "login.html";
    });

    const modalBackdrop = document.getElementById("modalBackdrop");
    const newReportBtn = document.getElementById("newReportBtn");
    const closeModalBtn = document.getElementById("closeModalBtn");
    const cancelBtn = document.getElementById("cancelBtn");
    const reportForm = document.getElementById("reportForm");
    const reportsBody = document.getElementById("reportsBody");
    const emptyState = document.getElementById("emptyState");
    const modalTitle = document.getElementById("modalTitle");

    const projektSelect = document.getElementById("projektSelect");
    const subprojektSelect = document.getElementById("subprojektSelect");

    let reports = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
    let projects = JSON.parse(localStorage.getItem(PROJECTS_KEY) || "[]");
    let subProjects = JSON.parse(localStorage.getItem(SUBPROJECTS_KEY) || "[]");

    let editingIndex = null;

    reports.forEach(r => {
      if (!r.status) r.status = "Ny";
      if (r.restid === undefined) r.restid = 0;
      if (r.rast === undefined) r.rast = 0;
    });
    saveReports();

    function saveReports() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(reports));
    }

    function toggleEmptyState() {
      emptyState.style.display = reports.length ? "none" : "block";
    }

    function calcBaseHours(start, end) {
      if (!start || !end) return 0;
      const [sh, sm] = start.split(":").map(Number);
      const [eh, em] = end.split(":").map(Number);
      let startMin = sh * 60 + sm;
      let endMin = eh * 60 + em;
      if (endMin <= startMin) endMin += 24 * 60;
      return (endMin - startMin) / 60;
    }

    function openModal(isEdit = false) {
      reloadProjectDropdowns();
      modalBackdrop.style.display = "flex";
      if (!isEdit) {
        modalTitle.textContent = "Ny tidrapport";
        const today = new Date().toISOString().slice(0, 10);
        document.getElementById("datum").value = today;
        document.getElementById("rast").value = "0";
        document.getElementById("restid").value = "0";
        document.getElementById("traktamente").value = "Ingen";
      } else {
        modalTitle.textContent = "Redigera tidrapport";
      }
    }

    function closeModal() {
      modalBackdrop.style.display = "none";
      reportForm.reset();
      editingIndex = null;
      modalTitle.textContent = "Ny tidrapport";
    }

    closeModalBtn.addEventListener("click", closeModal);
    cancelBtn.addEventListener("click", closeModal);
    modalBackdrop.addEventListener("click", (e) => {
      if (e.target === modalBackdrop) closeModal();
    });

    newReportBtn.addEventListener("click", () => openModal(false));

    function reloadProjectDropdowns(selectedProjectId = "", selectedSubId = "") {
      projects = JSON.parse(localStorage.getItem(PROJECTS_KEY) || "[]");
      subProjects = JSON.parse(localStorage.getItem(SUBPROJECTS_KEY) || "[]");

      projektSelect.innerHTML = "";
      const defaultOpt = document.createElement("option");
      defaultOpt.value = "";
      defaultOpt.textContent = "V√§lj projekt";
      projektSelect.appendChild(defaultOpt);

      projects
        .filter(p => p.status === "aktiv")
        .forEach((p) => {
          const opt = document.createElement("option");
          opt.value = p.id;
          opt.textContent = p.name;
          projektSelect.appendChild(opt);
        });

      if (selectedProjectId) {
        projektSelect.value = selectedProjectId;
      }

      reloadSubDropdown(selectedProjectId || projektSelect.value, selectedSubId);
    }

    function reloadSubDropdown(projectId, selectedSubId = "") {
      subprojektSelect.innerHTML = "";
      const defaultOpt = document.createElement("option");
      defaultOpt.value = "";
      defaultOpt.textContent = "Inget underprojekt";
      subprojektSelect.appendChild(defaultOpt);

      if (!projectId) return;

      subProjects
        .filter(sp => sp.projectId === projectId)
        .forEach((sp) => {
          const opt = document.createElement("option");
          opt.value = sp.id;
          opt.textContent = sp.name;
          subprojektSelect.appendChild(opt);
        });

      if (selectedSubId) {
        subprojektSelect.value = selectedSubId;
      }
    }

    projektSelect.addEventListener("change", () => {
      reloadSubDropdown(projektSelect.value);
    });

    function render() {
      reportsBody.innerHTML = "";

      reports.forEach((r, index) => {
        const tr = document.createElement("tr");
        const timmar = parseFloat(r.timmar || "0") || 0;
        const rast = Number(r.rast || 0);
        const restid = Number(r.restid || 0);

        const projectName = r.projectName || r.projekt || "-";
        const subName = r.subProjectName || "";

        tr.innerHTML = `
          <td>${r.datum || "-"}</td>
          <td>${projectName}</td>
          <td>${subName || "-"}</td>
          <td>${r.starttid || "-"}</td>
          <td>${r.sluttid || "-"}</td>
          <td>${r.roll || "-"}</td>
          <td>${r.beskrivning || ""}</td>
          <td>${rast}</td>
          <td>${restid.toFixed(1)}</td>
          <td>${timmar.toFixed(1)}</td>
          <td>
            <div class="actions">
              ${
                r.status === "Attesterad"
                  ? `<span class="lock-label">üîí L√•st (attesterad)</span>`
                  : `
                    <button type="button" class="btn-small edit">Redigera</button>
                    <button type="button" class="btn-small delete">Ta bort</button>
                    `
              }
            </div>
          </td>
        `;

        if (r.status !== "Attesterad") {
          const editBtn = tr.querySelector(".btn-small.edit");
          const deleteBtn = tr.querySelector(".btn-small.delete");

          editBtn.addEventListener("click", () => {
            editingIndex = index;

            document.getElementById("datum").value = r.datum || "";
            document.getElementById("rast").value = r.rast || 0;
            document.getElementById("starttid").value = r.starttid || "";
            document.getElementById("sluttid").value = r.sluttid || "";
            document.getElementById("roll").value = r.roll || "";
            document.getElementById("beskrivning").value = r.beskrivning || "";
            document.getElementById("traktamente").value = r.traktamente || "Ingen";
            document.getElementById("restid").value = r.restid || 0;

            const projId = r.projectId || "";
            const subId = r.subProjectId || "";

            openModal(true);
            reloadProjectDropdowns(projId, subId);
          });

          deleteBtn.addEventListener("click", () => {
            if (!confirm("Vill du ta bort den h√§r tidrapporten?")) return;
            reports.splice(index, 1);
            saveReports();
            render();
          });
        }

        reportsBody.appendChild(tr);
      });

      toggleEmptyState();
    }

    render();

    reportForm.addEventListener("submit", (e) => {
      e.preventDefault();

      const datum = document.getElementById("datum").value;
      const rastMin = Number(document.getElementById("rast").value || 0);
      const starttid = document.getElementById("starttid").value;
      const sluttid = document.getElementById("sluttid").value;
      const roll = document.getElementById("roll").value;
      const beskrivning = document.getElementById("beskrivning").value;
      const traktamente = document.getElementById("traktamente").value;
      const restid = Number(document.getElementById("restid").value || 0);

      const projectId = projektSelect.value || "";
      const subProjectId = subprojektSelect.value || "";

      const projectObj = projects.find(p => p.id === projectId);
      const subObj = subProjects.find(sp => sp.id === subProjectId);

      const projectName = projectObj ? projectObj.name : "";
      const subProjectName = subObj ? subObj.name : "";

      if (!datum || !starttid || !sluttid) {
        alert("Fyll i datum, starttid och sluttid.");
        return;
      }

      const baseHours = calcBaseHours(starttid, sluttid);
      let hours = baseHours - rastMin / 60 + restid;
      if (hours < 0) hours = 0;

      const baseReport = {
        datum,
        rast: rastMin,
        starttid,
        sluttid,
        roll: roll || "-",
        beskrivning,
        traktamente,
        restid,
        timmar: hours.toFixed(1),
        projectId,
        projectName: projectName || "-",
        subProjectId,
        subProjectName: subProjectName || "",
        // beh√•ller "projekt" f√∂r bak√•tkomp
        projekt: projectName || "-"
      };

      if (editingIndex !== null) {
        const old = reports[editingIndex];
        reports[editingIndex] = {
          ...old,
          ...baseReport,
          status: old.status || "Ny",
        };
      } else {
        reports.push({
          ...baseReport,
          status: "Ny",
        });
      }

      saveReports();
      render();
      closeModal();
    });
  </script>
</body>
</html>
