<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <title>Tidrapporter</title>
  <style>
    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      background: #f3f4f6;
    }

    .sidebar {
      width: 240px;
      background: #0f172a;
      color: #e5e7eb;
      padding: 16px 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .sidebar h2 {
      font-size: 18px;
      margin: 0 0 16px;
    }

    .nav-section-title {
      font-size: 11px;
      text-transform: uppercase;
      opacity: 0.6;
      margin-top: 12px;
    }

    .nav-item {
      padding: 8px 10px;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
      text-decoration: none;
      color: inherit;
      display: block;
    }

    .nav-item.active { background: #1d4ed8; }
    .nav-item:hover { background: #111827; }

    .logout {
      margin-top: auto;
      font-size: 13px;
      color: #f97373;
      cursor: pointer;
    }

    .main { flex: 1; padding: 24px 32px; }

    .topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }

    .topbar h1 { margin: 0; font-size: 22px; }
    .topbar small { color: #6b7280; }
    .welcome { font-size: 14px; color: #374151; }

    .page-layout {
      display: grid;
      grid-template-columns: minmax(0, 1.6fr) minmax(0, 1.4fr);
      gap: 20px;
      align-items: flex-start;
    }

    .card {
      background: #fff;
      border-radius: 12px;
      padding: 16px 18px;
      box-shadow: 0 8px 20px rgba(15,23,42,0.08);
    }

    .card h2 {
      margin: 0 0 10px;
      font-size: 18px;
    }

    .field-group {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px 16px;
      margin-top: 8px;
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 13px;
    }

    .field label {
      color: #374151;
    }

    .field input,
    .field select,
    .field textarea {
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      font-size: 13px;
    }

    .field input:focus,
    .field select:focus,
    .field textarea:focus {
      outline: none;
      border-color: #2563eb;
      box-shadow: 0 0 0 1px #2563eb25;
    }

    textarea {
      resize: vertical;
      min-height: 60px;
    }

    .btn-primary {
      padding: 8px 16px;
      border-radius: 999px;
      border: none;
      background: #1d4ed8;
      color: #fff;
      font-weight: 500;
      font-size: 14px;
      cursor: pointer;
    }

    .btn-primary:hover { background: #1e40af; }

    .btn-secondary {
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      background: #fff;
      font-size: 13px;
      cursor: pointer;
    }

    .btn-secondary:hover { background: #f3f4f6; }

    .btn-small {
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      background: #fff;
      font-size: 11px;
      cursor: pointer;
    }

    .btn-small.delete {
      border-color: #f87171;
      color: #b91c1c;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    th, td {
      padding: 6px 8px;
      border-bottom: 1px solid #e5e7eb;
      text-align: left;
      vertical-align: top;
    }

    th {
      font-size: 11px;
      text-transform: uppercase;
      color: #6b7280;
    }

    .badge-empty {
      font-size: 13px;
      color: #6b7280;
      margin-top: 8px;
    }
  </style>
</head>
<body>
  <!-- SIDEBAR -->
  <aside class="sidebar">
    <h2>Admina Bas</h2>

    <div class="nav-section">
      <a href="dashboard.html" class="nav-item">Översikt</a>
      <a href="tidrapporter.html" class="nav-item active">Tidrapporter</a>
      <a href="planning.html" class="nav-item">Planering</a>
      <a href="deviations.html" class="nav-item">Avvikelser</a>
      <a href="salary-overview.html" class="nav-item">Lönöversikt</a>
      <a href="contacts.html" class="nav-item">Kontakter</a>
    </div>

    <div class="nav-section-title">Administration</div>
    <a href="admin.html" class="nav-item">Attestering</a>
    <a href="projects.html" class="nav-item">Projekt</a>
    <a href="job_roles.html" class="nav-item">Yrkesroller</a>
    <a href="material_types.html" class="nav-item">Materialtyper</a>
    <a href="ob_settings.html" class="nav-item">OB-inställningar</a>
    <a href="admin-users.html" class="nav-item">Användare</a>

    <div class="logout" id="logoutBtn">⬅ Logga ut</div>
  </aside>

  <!-- MAIN -->
  <main class="main">
    <div class="topbar">
      <div>
        <h1>Tidrapport</h1>
        <small>Registrera arbetad tid och materialförbrukning</small>
      </div>
      <div class="welcome" id="welcomeText">Välkommen</div>
    </div>

    <div class="page-layout">
      <!-- TIDRAPPORT-FORM -->
      <section class="card">
        <h2>Ny tidrapport</h2>
        <form id="timeForm">
          <div class="field-group">
            <div class="field">
              <label for="date">Datum</label>
              <input id="date" type="date" required />
            </div>
            <div class="field">
              <label for="projectSelect">Projekt</label>
              <select id="projectSelect" required>
                <option value="">Välj projekt (läggs till av admin)</option>
              </select>
              <small style="color:#6b7280;">Projekt skapas av admin under sidan Projekt.</small>
            </div>
            <div class="field">
              <label for="start">Starttid</label>
              <input id="start" type="time" step="600" required />
            </div>
            <div class="field">
              <label for="end">Sluttid</label>
              <input id="end" type="time" step="600" required />
            </div>
            <div class="field">
              <label for="jobRole">Yrkesroll</label>
              <!-- ✅ DROPDOWN, INTE INPUT -->
              <select id="jobRole" required>
                <option value="">Välj yrkesroll</option>
              </select>
            </div>
          </div>

          <div class="field" style="margin-top:12px;">
            <label for="comment">Kommentar (valfritt)</label>
            <textarea id="comment" placeholder="Kort beskrivning av arbetet..."></textarea>
          </div>

          <!-- MATERIALFÖRBRUKNING -->
          <div style="margin-top:16px;">
            <h3 style="margin:0 0 6px; font-size:16px;">Materialförbrukning</h3>
            <p style="font-size:12px; color:#6b7280; margin:0 0 6px;">
              Välj materialtyp (förbrukningsmaterial) som admin har lagt in. Användare kan inte skapa egna materialtyper.
            </p>

            <div class="field-group">
              <div class="field">
                <label for="materialTypeSelect">Materialtyp</label>
                <select id="materialTypeSelect">
                  <option value="">Välj materialtyp</option>
                </select>
              </div>
              <div class="field">
                <label for="materialQty">Antal</label>
                <input id="materialQty" type="number" step="0.01" min="0" />
              </div>
              <div class="field">
                <label for="materialPlace">Var användes materialet?</label>
                <input id="materialPlace" type="text" placeholder="Ex. Spår 3, sektion A" />
              </div>
              <div class="field" style="align-self:flex-end;">
                <button type="button" id="addMaterialBtn" class="btn-secondary">
                  Lägg till material
                </button>
              </div>
            </div>

            <table style="margin-top:10px;">
              <thead>
                <tr>
                  <th>Materialtyp</th>
                  <th>Antal</th>
                  <th>Plats</th>
                  <th></th>
                </tr>
              </thead>
              <tbody id="materialsTableBody"></tbody>
            </table>
            <div id="noReportMaterials" class="badge-empty">
              Inga materialrader tillagda.
            </div>
          </div>

          <div style="margin-top:16px; display:flex; justify-content:flex-end; gap:8px;">
            <button type="submit" class="btn-primary">Spara tidrapport</button>
          </div>
        </form>
      </section>

      <!-- ENKEL LISTA ÖVER SPARADE RAPPORTER (LOCALSTORAGE) -->
      <section class="card">
        <h2>Sparade rapporter (lokalt)</h2>
        <table>
          <thead>
            <tr>
              <th>Datum</th>
              <th>Projekt</th>
              <th>Yrkesroll</th>
              <th>Materialrader</th>
            </tr>
          </thead>
          <tbody id="reportsBody"></tbody>
        </table>
        <div id="noReports" class="badge-empty">
          Inga rapporter sparade lokalt på denna enhet ännu.
        </div>
      </section>
    </div>
  </main>

  <script src="auth.js"></script>
  <script>
    const currentUser = requireLogin();
    setupSidebarForUser(currentUser);

    document.getElementById("logoutBtn").addEventListener("click", () => {
      localStorage.clear();
      window.location.href = "login.html";
    });

    const jobRoleSelect = document.getElementById("jobRole");
    const materialTypeSelect = document.getElementById("materialTypeSelect");
    const addMaterialBtn = document.getElementById("addMaterialBtn");
    const materialsTableBody = document.getElementById("materialsTableBody");
    const noReportMaterials = document.getElementById("noReportMaterials");
    const reportsBody = document.getElementById("reportsBody");
    const noReports = document.getElementById("noReports");
    const timeForm = document.getElementById("timeForm");
    const projectSelect = document.getElementById("projectSelect");

    let currentMaterials = [];
    const PROJECTS_KEY = "projects";

    // ===== HÄMTA YRKESROLLER (dropdown, ingen fri text) =====
    async function loadJobRoles() {
      try {
        const res = await fetch("/job-roles");
        const roles = await res.json();

        jobRoleSelect.innerHTML = '<option value="">Välj yrkesroll</option>';
        roles.forEach(role => {
          const opt = document.createElement("option");
          opt.value = role.id;
          opt.textContent = role.name;
          jobRoleSelect.appendChild(opt);
        });
      } catch (err) {
        console.error(err);
        alert("Kunde inte hämta yrkesroller.");
      }
    }

    // ===== HÄMTA MATERIALTYPER =====
    async function loadMaterialTypes() {
      try {
        const res = await fetch("/material-types");
        const materials = await res.json();

        materialTypeSelect.innerHTML = '<option value="">Välj materialtyp</option>';
        materials.forEach(mat => {
          const opt = document.createElement("option");
          opt.value = mat.id;
          opt.textContent = mat.unit
            ? `${mat.name} (${mat.unit})`
            : mat.name;
          materialTypeSelect.appendChild(opt);
        });
      } catch (err) {
        console.error(err);
        alert("Kunde inte hämta materialtyper.");
      }
    }

    function loadProjects() {
      let projects = [];
      try {
        projects = JSON.parse(localStorage.getItem(PROJECTS_KEY) || "[]");
      } catch {
        projects = [];
      }

      // Visa endast aktiva projekt om flagga finns, annars alla
      const activeProjects = projects.filter(p => p.active !== false);

      projectSelect.innerHTML =
        '<option value="">Välj projekt (läggs till av admin)</option>';

      activeProjects.forEach(p => {
        const opt = document.createElement("option");
        opt.value = p.id;
        opt.textContent = p.name || "Namnlöst projekt";
        opt.dataset.name = p.name || "";
        projectSelect.appendChild(opt);
      });

      projectSelect.disabled = activeProjects.length === 0;
    }

    function computeHours(dateStr, startStr, endStr) {
      if (!dateStr || !startStr || !endStr) return 0;

      const [sh, sm] = startStr.split(":").map(Number);
      const [eh, em] = endStr.split(":").map(Number);

      const startDate = new Date(dateStr);
      startDate.setHours(sh || 0, sm || 0, 0, 0);

      const endDate = new Date(dateStr);
      endDate.setHours(eh || 0, em || 0, 0, 0);

      if (endDate <= startDate) {
        // Om sluttid är före starttid, anta dygnsbyte
        endDate.setDate(endDate.getDate() + 1);
      }

      const diffMinutes = (endDate - startDate) / 60000;
      // Runda till närmaste 10-minutersintervall (krav: varje timme/10 min)
      const roundedMinutes = Math.round(diffMinutes / 10) * 10;
      const roundedHours = roundedMinutes / 60;

      return roundedHours > 0 ? parseFloat(roundedHours.toFixed(2)) : 0;
    }

    function renderMaterialsTable() {
      materialsTableBody.innerHTML = "";

      if (!currentMaterials.length) {
        noReportMaterials.style.display = "block";
        return;
      }
      noReportMaterials.style.display = "none";

      currentMaterials.forEach((row, index) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${row.typeName}</td>
          <td>${row.quantity}</td>
          <td>${row.place || "-"}</td>
          <td>
            <button type="button" class="btn-small delete" data-index="${index}">
              Ta bort
            </button>
          </td>
        `;
        materialsTableBody.appendChild(tr);
      });

      materialsTableBody.querySelectorAll(".btn-small.delete").forEach(btn => {
        btn.addEventListener("click", () => {
          const idx = parseInt(btn.getAttribute("data-index"), 10);
          currentMaterials.splice(idx, 1);
          renderMaterialsTable();
        });
      });
    }

    addMaterialBtn.addEventListener("click", () => {
      const typeId = materialTypeSelect.value;
      const typeName = materialTypeSelect.options[materialTypeSelect.selectedIndex]?.textContent || "";
      const qty = document.getElementById("materialQty").value;
      const place = document.getElementById("materialPlace").value.trim();

      if (!typeId) {
        alert("Välj materialtyp.");
        return;
      }
      if (!qty || Number(qty) <= 0) {
        alert("Ange antal > 0.");
        return;
      }

      currentMaterials.push({
        typeId,
        typeName,
        quantity: Number(qty),
        place
      });

      // Nollställ fält
      document.getElementById("materialQty").value = "";
      document.getElementById("materialPlace").value = "";

      renderMaterialsTable();
    });

    // ===== SPARA TIDRAPPORT (lokalt, inkl. materialförbrukning) =====
    function getUserName() {
      const storedName = localStorage.getItem("user_name");
      if (storedName) return storedName;

      const first =
        currentUser?.first_name || currentUser?.firstName || "";
      const last =
        currentUser?.last_name || currentUser?.lastName || "";

      const name = `${first || ""} ${last || ""}`.trim();
      return name || currentUser?.email || "";
    }

    function normalizeReport(rep) {
      const normalized = { ...rep };
      normalized.datum = normalized.datum || normalized.date || "";
      normalized.starttid = normalized.starttid || normalized.start || "";
      normalized.sluttid = normalized.sluttid || normalized.end || "";
      normalized.timmar =
        normalized.timmar != null && normalized.timmar !== ""
          ? Number(normalized.timmar) || 0
          : computeHours(normalized.datum, normalized.starttid, normalized.sluttid);

      normalized.userName = normalized.userName || getUserName();
      normalized.projectId = normalized.projectId || normalized.projektId || "";
      normalized.projectName =
        normalized.projectName ||
        normalized.projekt ||
        normalized.project ||
        "";
      normalized.projekt = normalized.projectName;

      return normalized;
    }

    function loadReportsFromStorage() {
      let list = [];
      try {
        const raw = localStorage.getItem("timeReports") || "[]";
        list = JSON.parse(raw);
      } catch {
        list = [];
      }
      const normalized = list.map(normalizeReport);
      saveReportsToStorage(normalized);
      return normalized;
    }

    function saveReportsToStorage(list) {
      localStorage.setItem("timeReports", JSON.stringify(list));
    }

    function renderReportsList() {
      const reports = loadReportsFromStorage();
      reportsBody.innerHTML = "";

      if (!reports.length) {
        noReports.style.display = "block";
        return;
      }
      noReports.style.display = "none";

      reports.forEach(rep => {
        const dateVal = rep.datum || rep.date || "-";
        const projectVal = rep.projekt || rep.projectName || rep.project || "-";
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${dateVal}</td>
          <td>${projectVal}</td>
          <td>${rep.jobRoleName || "-"}</td>
          <td>${(rep.materials || []).length}</td>
        `;
        reportsBody.appendChild(tr);
      });
    }

    timeForm.addEventListener("submit", (e) => {
      e.preventDefault();

      const date = document.getElementById("date").value;
      const projectId = projectSelect.value;
      const projectName =
        projectSelect.options[projectSelect.selectedIndex]?.dataset.name ||
        projectSelect.options[projectSelect.selectedIndex]?.textContent ||
        "";
      const start = document.getElementById("start").value;
      const end = document.getElementById("end").value;
      const jobRoleId = jobRoleSelect.value;
      const jobRoleName =
        jobRoleSelect.options[jobRoleSelect.selectedIndex]?.textContent || "";
      const comment = document.getElementById("comment").value.trim();

      if (!date || !projectId || !start || !end || !jobRoleId) {
        alert("Fyll i datum, projekt, tider och yrkesroll.");
        return;
      }

      const hoursVal = computeHours(date, start, end);
      if (!hoursVal || hoursVal <= 0) {
        alert("Sluttid måste vara efter starttid (kan gå över midnatt).");
        return;
      }

      const userName = getUserName();

      const reports = loadReportsFromStorage();
      const report = {
        id: Date.now(),
        userId: currentUser?.id || null,
        userName,
        datum: date,
        date,
        projekt: projectName,
        projectName,
        projectId,
        starttid: start,
        sluttid: end,
        start,
        end,
        jobRoleId,
        jobRoleName,
        timmar: hoursVal,
        hours: hoursVal,
        comment,
        materials: currentMaterials
      };

      reports.push(report);
      saveReportsToStorage(reports);

      alert("Tidrapport sparad lokalt inklusive materialförbrukning.");

      timeForm.reset();
      currentMaterials = [];
      renderMaterialsTable();
      renderReportsList();
    });

    // Init
    loadJobRoles();
    loadMaterialTypes();
    loadProjects();
    renderMaterialsTable();
    renderReportsList();
  </script>
</body>
</html>
